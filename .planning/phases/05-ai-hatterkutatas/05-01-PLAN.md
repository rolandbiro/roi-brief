---
phase: 05-ai-hatterkutatas
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/research/types.ts
  - lib/research/template-mapper.ts
  - lib/research/prompts.ts
autonomous: true

must_haves:
  truths:
    - "A ResearchResults Zod schema definiálja a kutatási eredmények struktúráját (channels, targeting, summary)"
    - "A template mapper a brief campaign_goal és campaign_types alapján kiválasztja a megfelelő mediaplan template típust"
    - "A research prompt-ok a brief adatait felhasználva magyar nyelvű kutatási utasításokat generálnak"
  artifacts:
    - path: "lib/research/types.ts"
      provides: "ResearchResults Zod schema + TypeScript típusok (KpiEstimate, ChannelRow, TargetingRow, CampaignSummary)"
      exports: ["ResearchResultsSchema", "ResearchResults", "KpiEstimate", "ChannelRow", "TargetingRow", "CampaignSummary", "MediaplanTemplate"]
    - path: "lib/research/template-mapper.ts"
      provides: "selectTemplate() — brief alapján template típus kiválasztás"
      exports: ["selectTemplate"]
    - path: "lib/research/prompts.ts"
      provides: "RESEARCH_SYSTEM_PROMPT, buildResearchPrompt(), STRUCTURE_SYSTEM_PROMPT"
      exports: ["RESEARCH_SYSTEM_PROMPT", "buildResearchPrompt", "STRUCTURE_SYSTEM_PROMPT"]
  key_links:
    - from: "lib/research/prompts.ts"
      to: "lib/research/types.ts"
      via: "MediaplanTemplate import a prompt template kontextushoz"
      pattern: "import.*MediaplanTemplate.*from.*types"
    - from: "lib/research/template-mapper.ts"
      to: "lib/research/types.ts"
      via: "MediaplanTemplate típus import"
      pattern: "import.*MediaplanTemplate.*from.*types"
---

<objective>
A research pipeline alapjainak létrehozása: típus definíciók, template mapper, és prompt-ok.

Purpose: Ezek a fájlok az alap infrastruktúra, amire a tényleges Claude API hívások (Plan 02) építenek. A Zod schema biztosítja a structured outputs kompatibilitást, a template mapper a brief-hez illő xlsx template kiválasztását, a prompt-ok pedig a kutatás minőségét.
Output: 3 fájl a lib/research/ könyvtárban — types.ts, template-mapper.ts, prompts.ts
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-hatterkutatas/05-RESEARCH.md
@lib/schemas/brief-data.ts
@lib/schemas/brief-base.ts
@lib/brief-sections.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ResearchResults Zod schema és típus definíciók</name>
  <files>lib/research/types.ts</files>
  <action>
Hozd létre a `lib/research/types.ts` fájlt az alábbi tartalommal:

1. `MediaplanTemplate` típus — enum-szerű string union: `"ppc_traffic" | "ppc_reach" | "ppc_mixed" | "all_channels"`

2. `KpiEstimate` Zod schema — `{ min: number, likely: number, max: number }` — a tartomány + ajánlott érték minta (user decision: "Tartomány + ajánlott érték: min-max tartomány és egy kiemelt valószínű érték")

3. `ChannelRow` Zod schema — egy PPC csatorna-hirdetés kombináció:
   - `campaign_target: z.string()` — "Traffic" | "Awareness" | "Conversion"
   - `campaign_type: z.string()` — "Prospecting" | "Retargeting"
   - `ad_network: z.string()` — "Google Display" | "Meta" | stb. (szabad, nem fix lista — user decision)
   - `ad_type: z.string()` — "Banner" | "Video" | "Search" | "Banner/Video"
   - `budget_allocation_pct: z.number()` — 0-100
   - `budget_allocation_huf: z.number()`
   - Metrikák MIND optional (user decision: "Kampánycéltól függő metrikák"):
     - `impressions`, `ctr`, `clicks`, `cpc` — Traffic metrikák
     - `frequency`, `reach`, `cpm`, `cpv` — Reach metrikák
     - `conversions`, `cpa` — Conversion metrikák
   - Minden metrika `KpiEstimate.optional()`

4. `TargetingRow` Zod schema:
   - `ad_network: z.string()`
   - `age: z.string()` — "20 - 62"
   - `gender: z.string()` — "Male / Female"
   - `location: z.string()` — "Budapest - HU"
   - `interest: z.string()` — szabad szöveg, platform-specifikus targeting

5. `CampaignSummary` Zod schema (user decision: "Csatornánkénti részletezés + kampány szintű összegzés"):
   - `total_budget_huf: z.number()`
   - Optional aggregált KPI-k: `total_impressions`, `total_clicks`, `total_reach`, `total_conversions`, `overall_ctr`, `overall_cpc`, `overall_cpm` — mind `KpiEstimate.optional()`

6. `ResearchResultsSchema` Zod schema — a fő output:
   - `template_type: z.enum(["ppc_traffic", "ppc_reach", "ppc_mixed", "all_channels"])`
   - `campaign_name: z.string()`
   - `campaign_period: z.string()`
   - `campaign_goal: z.string()`
   - `channels: z.array(ChannelRow)`
   - `targeting: z.array(TargetingRow)`
   - `summary: CampaignSummary`
   - `research_notes: z.string()` — AI megjegyzések, bizonytalanságok jelzése
   - `sources: z.array(z.string())` — web search források

7. Exportáld a `z.infer<>` típusokat is: `ResearchResults`, `KpiEstimate` (type), `ChannelRow` (type), `TargetingRow` (type), `CampaignSummary` (type).

FONTOS: A Zod schema-nak egyszerűnek kell maradnia — structured outputs JSON Schema limitáció (no recursive, additionalProperties: false automatic). Ne használj `.refine()` vagy `.transform()` metódusokat — ezek nem kompatibilisek a `zodOutputFormat()`-tal.

Import: `import { z } from "zod";`
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>A lib/research/types.ts exportálja a ResearchResultsSchema Zod schemát és az összes TypeScript típust. A tsc hiba nélkül fut.</done>
</task>

<task type="auto">
  <name>Task 2: Template mapper és research prompt-ok</name>
  <files>lib/research/template-mapper.ts, lib/research/prompts.ts</files>
  <action>
**template-mapper.ts:**

Hozd létre a `lib/research/template-mapper.ts` fájlt:

1. Import: `MediaplanTemplate` from `./types`, `BriefData` from `@/types/brief`
2. `selectTemplate(briefData: BriefData): MediaplanTemplate` függvény:
   - Vizsgálja a `briefData.campaign_types` tömböt és a `briefData.campaign_goal` szöveget
   - Ha több csatorna típus van (media_buying vagy social_media benne, vagy 2-nál több típus) → `"all_channels"`
   - Ha campaign_goal tartalmaz traffic/forgalom/kattintás/konverzió/conversion/lead mintát → traffic jelzés
   - Ha campaign_goal tartalmaz awareness/ismertség/reach/elérés/megjelenés/brand mintát → reach jelzés
   - Ha mindkettő → `"ppc_mixed"`, ha csak reach → `"ppc_reach"`, egyébként `"ppc_traffic"` (default)
   - Case-insensitive regex matching

**prompts.ts:**

Hozd létre a `lib/research/prompts.ts` fájlt:

1. Import: `BriefData` from `@/types/brief`, `MediaplanTemplate` from `./types`

2. `RESEARCH_SYSTEM_PROMPT: string` — rendszerprompt a Step 1 (web search) híváshoz:
   - Szerepe: magyar piaci digitális marketing szakértő, mediaplan kutatáshoz
   - Feladata: benchmark adatok keresése, csatorna mix javaslat, targeting ajánlás, KPI becslés
   - Lokalizáció: magyar piacra vonatkozó adatokat keressen, HUF árazással
   - Fontos: NE generáljon JSON-t, szabad szöveges kutatási összefoglalót adjon
   - Web search használata: iparági benchmark CPM/CPC/CTR adatok, versenytárs aktivitás, platform specifikus targeting lehetőségek

3. `buildResearchPrompt(briefData: BriefData, templateType: MediaplanTemplate): string` — a user prompt a Step 1-hez:
   - A brief mezőit beilleszti: company_name, industry, campaign_goal, budget_range, célcsoport adatok (age_range, gender, location), időszak (start_date, end_date), ad_channels, competitors
   - Hiányzó mezőknél "nincs megadva" szöveget ír
   - A templateType alapján specifikus utasításokat ad (traffic metrikákra fókuszáljon, reach metrikákra, mindkettőre, vagy all channels)
   - 5 feladatot ad meg: benchmark keresés, versenytárs kutatás, csatorna mix javaslat, targeting javaslat, KPI becslés
   - Tömb típusú mezőket `.join(", ")`-nel fűzi össze

4. `STRUCTURE_SYSTEM_PROMPT: string` — rendszerprompt a Step 2 (structured output) híváshoz:
   - Szerepe: a kutatási eredmények strukturált JSON formátumba rendezése
   - Feladata: a szabad szöveges kutatást a ResearchResults schema szerint formázza
   - KPI becslések: min (konzervatív), likely (reális), max (optimista) tartomány
   - Budget elosztás: minden csatornára %-ban és HUF-ban is
   - Fontos: ahol nincs elegendő adat, jelezze a research_notes-ban

Mindkét fájlban ÉKEZETES MAGYAR szöveget használj a prompt-okban.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>A template-mapper.ts exportálja a selectTemplate függvényt, a prompts.ts exportálja a RESEARCH_SYSTEM_PROMPT, buildResearchPrompt, és STRUCTURE_SYSTEM_PROMPT konstansokat/függvényeket. A tsc hiba nélkül fut.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript compilation hiba nélkül
2. `ls lib/research/` — types.ts, template-mapper.ts, prompts.ts létezik
3. A ResearchResultsSchema kompatibilis a `zodOutputFormat()` helper-rel (nincs refine/transform)
</verification>

<success_criteria>
- A lib/research/ könyvtár tartalmazza a 3 alap fájlt
- A ResearchResultsSchema Zod schema a structured outputs API-val kompatibilis
- A selectTemplate a brief alapján helyesen választja ki a 4 template típus egyikét
- A prompt-ok ékezetes magyar szöveget tartalmaznak
- TypeScript compilation sikeres
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-hatterkutatas/05-01-SUMMARY.md`
</output>
