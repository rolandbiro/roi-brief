---
phase: 05-ai-hatterkutatas
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - lib/research/search.ts
  - lib/research/structure.ts
  - lib/research/pipeline.ts
  - app/api/approve/route.ts
autonomous: true

must_haves:
  truths:
    - "A jóváhagyás után a szerver háttérben (fire-and-forget) futtatja az AI kutatást — az ügyfélnek azonnal válaszolunk"
    - "A pipeline web search-öt használ valós piaci adatok kutatásához (Anthropic web_search_20250305 tool)"
    - "A pipeline structured output-ot használ a kutatási eredmények ResearchResults schemába rendezéséhez"
    - "A pause_turn stop reason kezelve van — a web search loop folytatódik ha az API megszakítja"
    - "A pipeline eredménye ResearchResults típusú strukturált JSON"
  artifacts:
    - path: "lib/research/search.ts"
      provides: "runWebSearch() — Step 1: Claude API hívás web_search tool-lal, pause_turn kezeléssel"
      exports: ["runWebSearch"]
    - path: "lib/research/structure.ts"
      provides: "structureResults() — Step 2: Claude API hívás zodOutputFormat-tal"
      exports: ["structureResults"]
    - path: "lib/research/pipeline.ts"
      provides: "runResearchPipeline() — fő orchestrator: template select → search → structure"
      exports: ["runResearchPipeline"]
    - path: "app/api/approve/route.ts"
      provides: "Approve endpoint runResearchPipeline() hívással az after() callback-ben"
      exports: ["POST"]
  key_links:
    - from: "lib/research/pipeline.ts"
      to: "lib/research/search.ts"
      via: "runWebSearch() hívás"
      pattern: "runWebSearch\\("
    - from: "lib/research/pipeline.ts"
      to: "lib/research/structure.ts"
      via: "structureResults() hívás"
      pattern: "structureResults\\("
    - from: "lib/research/pipeline.ts"
      to: "lib/research/template-mapper.ts"
      via: "selectTemplate() hívás"
      pattern: "selectTemplate\\("
    - from: "app/api/approve/route.ts"
      to: "lib/research/pipeline.ts"
      via: "runResearchPipeline() hívás az after() callback-ben"
      pattern: "runResearchPipeline\\("
---

<objective>
A research pipeline megvalósítása: web search kutatás, structured output formázás, és az approve route bekötése.

Purpose: Ez a plan implementálja a két lépéses Claude API pipeline-t (search → structure), ami a brief adataiból strukturált mediaplan kutatási eredményeket generál. A pipeline fire-and-forget módon fut az approve endpoint-ból.
Output: 3 új fájl (search.ts, structure.ts, pipeline.ts) + az approve route frissítése
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ai-hatterkutatas/05-RESEARCH.md
@.planning/phases/05-ai-hatterkutatas/05-01-SUMMARY.md
@lib/research/types.ts
@lib/research/template-mapper.ts
@lib/research/prompts.ts
@app/api/approve/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Web search és structured output Claude API hívások</name>
  <files>lib/research/search.ts, lib/research/structure.ts</files>
  <action>
**search.ts — Step 1: Web search kutatás:**

Hozd létre a `lib/research/search.ts` fájlt:

1. Import: `Anthropic` from `"@anthropic-ai/sdk"`, prompt-ok from `./prompts`, `BriefData` from `@/types/brief`, `MediaplanTemplate` from `./types`

2. `runWebSearch(briefData: BriefData, templateType: MediaplanTemplate): Promise<string>` async függvény:

   - Hozd létre az Anthropic klienst: `new Anthropic()` (az ANTHROPIC_API_KEY env var-t automatikusan használja)

   - Inicializáld a `messages` tömböt: `[{ role: "user" as const, content: buildResearchPrompt(briefData, templateType) }]`

   - **pause_turn loop** (KRITIKUS — research pitfall #3):
     ```
     let fullContent = ""
     let continueLoop = true

     while (continueLoop) {
       const response = await anthropic.messages.create({
         model: "claude-sonnet-4-20250514",
         max_tokens: 8192,
         system: RESEARCH_SYSTEM_PROMPT,
         messages,
         tools: [{
           type: "web_search_20250305" as const,
           name: "web_search",
           max_uses: 5,
           user_location: {
             type: "approximate" as const,
             country: "HU",
             city: "Budapest",
             timezone: "Europe/Budapest"
           }
         }]
       })

       if (response.stop_reason === "pause_turn") {
         // Folytatjuk — az eredeti query + eddigi válasz visszaküldése
         messages.length = 0
         messages.push(
           { role: "user" as const, content: buildResearchPrompt(briefData, templateType) },
           { role: "assistant" as const, content: response.content as Anthropic.ContentBlock[] }
         )
         continue
       }

       // Szöveges tartalom kinyerése
       for (const block of response.content) {
         if (block.type === "text") {
           fullContent += block.text
         }
       }
       continueLoop = false
     }

     return fullContent
     ```

   - NEM használunk streaming-et (after() callback-ben nincs kinek streamelni — research anti-pattern)
   - NEM használunk `output_config`-ot (web_search citations inkompatibilis — research pitfall #1)

**structure.ts — Step 2: Structured output formázás:**

Hozd létre a `lib/research/structure.ts` fájlt:

1. Import: `Anthropic` from `"@anthropic-ai/sdk"`, `zodOutputFormat` from `"@anthropic-ai/sdk/helpers/zod"`, `ResearchResultsSchema` és `ResearchResults` from `./types`, `STRUCTURE_SYSTEM_PROMPT` from `./prompts`, `BriefData` from `@/types/brief`

2. `structureResults(rawResearch: string, briefData: BriefData): Promise<ResearchResults>` async függvény:

   - Hozd létre az Anthropic klienst: `new Anthropic()`

   - Claude API hívás structured output-tal:
     ```
     const response = await anthropic.messages.create({
       model: "claude-sonnet-4-20250514",
       max_tokens: 8192,
       system: STRUCTURE_SYSTEM_PROMPT,
       messages: [{
         role: "user",
         content: `Kutatási eredmények:\n\n${rawResearch}\n\nBrief adatok:\n- Kampány név: ${briefData.campaign_name || briefData.company_name + " kampány"}\n- Kampány cél: ${briefData.campaign_goal}\n- Büdzsé: ${briefData.budget_range || "nem megadott"}\n- Időszak: ${briefData.start_date || "?"} - ${briefData.end_date || "?"}`
       }],
       output_config: {
         format: zodOutputFormat(ResearchResultsSchema)
       }
     })
     ```

   - A válasz első text block-jából parse-olja a JSON-t: `JSON.parse(response.content[0].text)` — a structured outputs garantálja a schema megfelelést, nincs szükség error handling-re a parse-nál (constrained decoding — 100% garancia)

   - FONTOS: NEM használunk `tools`-t ebben a hívásban (research pitfall #1: citations + output_config inkompatibilis)
   - A `response.content[0]` mindig `text` típusú lesz structured output esetén
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>A search.ts exportálja a runWebSearch függvényt (Claude + web_search + pause_turn kezelés), a structure.ts exportálja a structureResults függvényt (Claude + zodOutputFormat). TypeScript compilation sikeres.</done>
</task>

<task type="auto">
  <name>Task 2: Pipeline orchestrator és approve route bekötés</name>
  <files>lib/research/pipeline.ts, app/api/approve/route.ts</files>
  <action>
**pipeline.ts — Fő orchestrator:**

Hozd létre a `lib/research/pipeline.ts` fájlt:

1. Import: `runWebSearch` from `./search`, `structureResults` from `./structure`, `selectTemplate` from `./template-mapper`, `BriefData` from `@/types/brief`, `ResearchResults` from `./types`

2. `runResearchPipeline(briefData: BriefData): Promise<ResearchResults>` async függvény:

   - **Step 0:** Template típus kiválasztás
     ```
     const templateType = selectTemplate(briefData)
     console.log('[research] Template type:', templateType)
     ```

   - **Step 1:** Web search kutatás
     ```
     console.log('[research] Starting web search for:', briefData.company_name)
     const rawResearch = await runWebSearch(briefData, templateType)
     console.log('[research] Web search complete, length:', rawResearch.length)
     ```

   - **Step 2:** Strukturált output formázás
     ```
     console.log('[research] Structuring results...')
     const results = await structureResults(rawResearch, briefData)
     console.log('[research] Pipeline complete. Channels:', results.channels.length, 'Targeting:', results.targeting.length)
     ```

   - Return `results`

   - Szándékosan NEM catch-elünk hibákat itt — a hívó (approve route) kezeli. A pipeline fail-fast logikát követ.

**approve route frissítés:**

Módosítsd az `app/api/approve/route.ts` fájlt:

1. Importáld: `import { runResearchPipeline } from '@/lib/research/pipeline'`

2. Az `after()` callback-ben cseréld a placeholder-t a valódi pipeline hívásra:
   ```
   after(async () => {
     try {
       const results = await runResearchPipeline(briefData)
       // Phase 6 will store/send results
       console.log('[approve] Research complete:', results.template_type, '- channels:', results.channels.length)
     } catch (error) {
       // Phase 6 will handle PM error notification
       console.error('[approve] Research pipeline error:', error)
     }
   })
   ```

3. Adj hozzá `maxDuration` route segment config-ot a Vercel timeout kezeléshez (research pitfall #2):
   ```
   export const maxDuration = 120 // 2 perc — after() callback-nek kell az idő
   ```
   Ez a fájl elejére kerüljön, a POST export elé.

4. Az `import { after } from 'next/server'` megmarad.

FONTOS: A results tárolása/küldése Phase 6 scope — itt csak console.log-gal jelezzük a sikert. A pipeline eredménye most "elvész" — Phase 6 fogja megoldani a persistálást.
  </action>
  <verify>npx tsc --noEmit && grep -q "runResearchPipeline" app/api/approve/route.ts && grep -q "maxDuration" app/api/approve/route.ts</verify>
  <done>A pipeline.ts exportálja a runResearchPipeline orchestrator függvényt. Az approve route-ban az after() callback a valódi pipeline-t hívja, maxDuration = 120 beállítva. A Phase 5 research pipeline teljes: approve → pipeline → search → structure → ResearchResults.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript compilation hiba nélkül
2. `ls lib/research/` — mind az 6 fájl létezik: types.ts, template-mapper.ts, prompts.ts, search.ts, structure.ts, pipeline.ts
3. `grep "runResearchPipeline" app/api/approve/route.ts` — a pipeline be van kötve az approve endpoint-ba
4. `grep "maxDuration" app/api/approve/route.ts` — Vercel timeout config beállítva
5. `grep "web_search_20250305" lib/research/search.ts` — web search tool definiálva
6. `grep "zodOutputFormat" lib/research/structure.ts` — structured output használva
7. `grep "pause_turn" lib/research/search.ts` — pause_turn kezelés implementálva
</verification>

<success_criteria>
- A research pipeline end-to-end össze van kötve: approve → pipeline → search → structure → ResearchResults
- A web search step pause_turn kezeléssel rendelkezik
- A structured output step zodOutputFormat-tal és ResearchResultsSchema-val dolgozik
- Web search és structured output SOHA nem egy API hívásban (citations incompatibility)
- A pipeline fire-and-forget módon fut az after() callback-ben
- maxDuration beállítva a Vercel timeout kezeléshez
- TypeScript compilation sikeres
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-hatterkutatas/05-02-SUMMARY.md`
</output>
