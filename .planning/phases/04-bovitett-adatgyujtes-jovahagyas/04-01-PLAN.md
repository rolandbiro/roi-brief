---
phase: 04-bovitett-adatgyujtes-jovahagyas
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/schemas/brief-base.ts
  - lib/schemas/brief-data.ts
  - lib/brief-sections.ts
  - lib/tools/definitions.ts
  - lib/prompts/extraction.ts
autonomous: true

must_haves:
  truths:
    - "A BriefBaseSchema tartalmazza az Agency Brief összes üzleti mezőjét (~25 mező flat struktúrában)"
    - "A company_name és campaign_goal kötelező, minden más mező optional"
    - "A timing és target_audience mező eltávolítva — helyettük részletesebb mezők (start_date, end_date, gender, age_range, stb.)"
    - "A szekció definíciók egyetlen helyen vannak definiálva (brief-sections.ts) és onnan importálva mindenhol"
    - "Az update_brief tool description tartalmazza az összes új mező nevét"
    - "Az extraction prompt ismeri az összes új Agency Brief mezőt"
  artifacts:
    - path: "lib/schemas/brief-base.ts"
      provides: "Bővített BriefBaseSchema ~25 Agency Brief mezővel"
      contains: "contact_name"
    - path: "lib/brief-sections.ts"
      provides: "AGENCY_BRIEF_SECTIONS centralizált szekció definíciók + getActiveSections"
      exports: ["AGENCY_BRIEF_SECTIONS", "getActiveSections"]
    - path: "lib/tools/definitions.ts"
      provides: "update_brief tool frissített mező lista leírással"
    - path: "lib/prompts/extraction.ts"
      provides: "Extraction prompt az Agency Brief mezőkkel"
  key_links:
    - from: "lib/schemas/brief-data.ts"
      to: "lib/schemas/brief-base.ts"
      via: "BriefBaseSchema.extend()"
      pattern: "BriefBaseSchema"
    - from: "lib/brief-sections.ts"
      to: "types/brief.ts"
      via: "BriefData type import"
      pattern: "BriefData"
---

<objective>
BriefBaseSchema bővítés az Agency Brief xlsx template ~25 mezőjével, szekció definíciók centralizálása, és az update_brief tool + extraction prompt frissítése az új mezőkkel.

Purpose: Az adatmodell és a hozzá kapcsolódó definíciók felkészítése a teljes Agency Brief adatgyűjtésre — ez a Plan 02 (prompt) és Plan 03 (UI) alapja.
Output: Bővített séma, centralizált szekciók, frissített tool definíciók és extraction prompt.
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-bovitett-adatgyujtes-jovahagyas/04-RESEARCH.md
@lib/schemas/brief-base.ts
@lib/schemas/brief-data.ts
@lib/schemas/index.ts
@lib/brief-sections.ts
@lib/tools/definitions.ts
@lib/prompts/extraction.ts
@lib/pdf-template.tsx
@lib/email-template.ts
@types/brief.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: BriefBaseSchema bővítés Agency Brief mezőkkel + szekció definíciók centralizálás</name>
  <files>lib/schemas/brief-base.ts, lib/brief-sections.ts, lib/pdf-template.tsx, lib/email-template.ts</files>
  <action>
**lib/schemas/brief-base.ts — TELJES ÁTÍRÁS:**

Cseréld le a jelenlegi BriefBaseSchema-t az Agency Brief xlsx template teljes mezőkészletével. Flat struktúra, nem nested. Az ékezetes `.describe()` stringeket pontosan kövesd:

```
BriefBaseSchema = z.object({
  // === Alapvető információk ===
  company_name: z.string().describe("Cégnév"),
  contact_name: z.string().optional().describe("Kapcsolattartó neve"),
  industry: z.string().optional().describe("Cég tevékenységi köre"),
  brand_positioning: z.string().optional().describe("Márka pozicionálása"),

  // === Kampány részletek ===
  campaign_name: z.string().optional().describe("Kampány neve"),
  campaign_goal: z.string().describe("Kampány célja"),
  main_message: z.string().optional().describe("Fő üzenet"),
  creative_source: z.array(z.string()).optional().describe("Kreatívok forrása"),
  creative_types: z.array(z.string()).optional().describe("Kreatív típusok"),
  communication_style: z.string().optional().describe("Kommunikációs stílus"),

  // === Csatornák és KPI-k ===
  ad_channels: z.array(z.string()).optional().describe("Online hirdetési csatornák"),
  kpis: z.array(z.string()).optional().describe("KPI-k"),

  // === Célcsoport ===
  gender: z.array(z.string()).optional().describe("Nem"),
  location: z.string().optional().describe("Lakóhely"),
  age_range: z.string().optional().describe("Kor"),
  psychographics: z.string().optional().describe("Pszichográfiai adatok"),
  persona: z.string().optional().describe("Ideális ügyfélprofil (Persona)"),

  // === Időzítés ===
  start_date: z.string().optional().describe("Indulási dátum"),
  end_date: z.string().optional().describe("Zárási dátum"),
  key_events: z.string().optional().describe("Fontos események"),

  // === Költségvetés ===
  budget_range: z.string().optional().describe("Allokált büdzsé (Ft)"),
  budget_allocation: z.string().optional().describe("Platformonkénti elosztási preferencia"),

  // === Versenytársak ===
  competitors: z.array(z.string()).optional().describe("Fő versenytársak"),
  inspiring_campaigns: z.string().optional().describe("Inspiráló kampányok vagy márkák"),

  // === Egyéb ===
  existing_materials: z.string().optional().describe("Meglévő anyagok"),
  previous_campaigns: z.string().optional().describe("Korábbi kampány tapasztalatok"),
  notes: z.string().optional().describe("Egyéb megjegyzések"),
});
```

FONTOS VÁLTOZÁSOK a v1.0-hoz képest:
- `company_name` marad kötelező (nem optional)
- `campaign_goal` marad kötelező (nem optional)
- `industry` → OPTIONAL-ra változik (eddig kötelező volt)
- `budget_range` → OPTIONAL-ra változik (eddig kötelező volt)
- `competitors` → OPTIONAL-ra változik (eddig kötelező volt)
- `timing` mező ELTÁVOLÍTVA → helyette `start_date`, `end_date`, `key_events`
- `target_audience` mező ELTÁVOLÍTVA → helyette `gender`, `location`, `age_range`, `psychographics`, `persona`
- ~15 ÚJ mező hozzáadva (contact_name, brand_positioning, campaign_name, main_message, stb.)

**lib/brief-sections.ts — ÁTÍRÁS centralizált Agency Brief szekciókkal:**

1. A meglévő `FieldDef`, `SectionDef`, `hasValue`, `getNestedValue`, `formatValue`, `formatCampaignTypes` helperek MARADNAK (a logika jó).

2. Cseréld le az `EXECUTIVE_SUMMARY_SECTION`, `BASE_SECTIONS` definíciókat egy új `AGENCY_BRIEF_SECTIONS` tömbre:

```typescript
export const AGENCY_BRIEF_SECTIONS: SectionDef[] = [
  {
    title: "Alapvető információk",
    fields: [
      { key: "company_name", label: "Cégnév" },
      { key: "contact_name", label: "Kapcsolattartó" },
      { key: "industry", label: "Tevékenységi kör" },
      { key: "brand_positioning", label: "Márka pozicionálás" },
    ],
  },
  {
    title: "Kampány részletek",
    fields: [
      { key: "campaign_name", label: "Kampány neve" },
      { key: "campaign_types", label: "Kampánytípusok" },
      { key: "campaign_goal", label: "Kampány célja" },
      { key: "main_message", label: "Fő üzenet" },
      { key: "communication_style", label: "Kommunikációs stílus" },
      { key: "creative_source", label: "Kreatívok forrása" },
      { key: "creative_types", label: "Kreatív típusok" },
    ],
  },
  {
    title: "Csatornák és mérés",
    fields: [
      { key: "ad_channels", label: "Hirdetési csatornák" },
      { key: "kpis", label: "KPI-k" },
    ],
  },
  {
    title: "Célcsoport",
    fields: [
      { key: "gender", label: "Nem" },
      { key: "age_range", label: "Kor" },
      { key: "location", label: "Lakóhely" },
      { key: "psychographics", label: "Érdeklődés, szokások" },
      { key: "persona", label: "Persona" },
    ],
  },
  {
    title: "Időzítés",
    fields: [
      { key: "start_date", label: "Indulás" },
      { key: "end_date", label: "Zárás" },
      { key: "key_events", label: "Fontos események" },
    ],
  },
  {
    title: "Költségvetés",
    fields: [
      { key: "budget_range", label: "Büdzsé" },
      { key: "budget_allocation", label: "Platformonkénti elosztás" },
    ],
  },
  {
    title: "Versenytársak",
    fields: [
      { key: "competitors", label: "Fő versenytársak" },
      { key: "inspiring_campaigns", label: "Inspiráló kampányok" },
    ],
  },
  {
    title: "Egyéb",
    fields: [
      { key: "existing_materials", label: "Meglévő anyagok" },
      { key: "previous_campaigns", label: "Korábbi kampányok" },
      { key: "notes", label: "Megjegyzések" },
    ],
  },
];
```

3. A `TYPE_SECTIONS` record MARAD változatlanul (a típusspecifikus szekciók nem változnak).

4. A `getActiveSections()` frissítése: az `EXECUTIVE_SUMMARY_SECTION`-t és `BASE_SECTIONS`-t cseréld le `AGENCY_BRIEF_SECTIONS`-re. A logika:
   - AGENCY_BRIEF_SECTIONS összes szekciója
   - Utána TYPE_SECTIONS a kampánytípusok alapján (ahogy eddig is)
   - campaign_types mező formázása `formatCampaignTypes`-szal (ahogy eddig)

5. Exportáld: `AGENCY_BRIEF_SECTIONS` (az `EXECUTIVE_SUMMARY_SECTION` és `BASE_SECTIONS` exportot távolítsd el, vagy hagyd meg deprecated alias-ként ha pdf/email importálja — de NE duplikáld a definíciókat).

**lib/pdf-template.tsx — szekció definíciók importálása brief-sections.ts-ből:**

Töröld a duplikált `EXECUTIVE_SUMMARY`, `BASE_SECTIONS`, `TYPE_SECTIONS` lokális definíciókat. Helyettük importáld a `AGENCY_BRIEF_SECTIONS` és `TYPE_SECTIONS` definíciókat a `lib/brief-sections.ts`-ből. A pdf-template saját `FieldDef`/`SectionDef` interface-ét is töröld — használd a brief-sections.ts-ből importáltat.

FONTOS: A pdf-template.tsx-ben a `FieldDef` interface `path` property-t használ (nem `key`-t mint a brief-sections.ts). A brief-sections.ts-ben a `FieldDef` interface `key` property-t használ. Az importálás után mappeld a `key`-t `path`-ra a `SectionView` komponensben, VAGY egységesítsd a `FieldDef`-et úgy, hogy mindkét helyen `key`-t használj (egyszerűbb, a pdf SectionView is key-ként kezeli).

A `SectionView` PDF komponens React-PDF View/Text elemekkel renderel — ez marad, csak a definíciós adat változik.

A lokális `hasValue`, `getNestedValue`, `formatValue` helper függvényeket is töröld és importáld a `lib/brief-sections.ts`-ből.

**lib/email-template.ts — szekció definíciók importálása brief-sections.ts-ből:**

Ugyanaz mint a pdf-template-nél: töröld a duplikált lokális `EXECUTIVE_SUMMARY`, `BASE_SECTIONS`, `TYPE_SECTIONS` definíciókat és a lokális `hasValue`, `getNestedValue`, `formatValue`, `FieldDef`, `SectionDef` definíciókat. Importáld mindet a `lib/brief-sections.ts`-ből.

A `renderSectionHtml` függvény HTML stringeket generál (nem React) — a függvény logikája marad, csak a szekció definíciókat importálja más helyről. A `field.path` → `field.key` átnevezés itt is szükséges.
  </action>
  <verify>npx tsc --noEmit — nincs TypeScript hiba. A BriefBaseSchema tartalmazza a company_name, contact_name, brand_positioning, campaign_name, main_message, ad_channels, kpis, gender, start_date, end_date, persona mezőket. A timing és target_audience mező NEM létezik a sémában.</verify>
  <done>A BriefBaseSchema ~25 Agency Brief mezőt tartalmaz flat struktúrában. A szekció definíciók egyetlen helyen (brief-sections.ts) vannak definiálva, és a pdf-template + email-template onnan importálja. Nincs duplikált szekció definíció.</done>
</task>

<task type="auto">
  <name>Task 2: update_brief tool description frissítés + extraction prompt bővítés</name>
  <files>lib/tools/definitions.ts, lib/prompts/extraction.ts</files>
  <action>
**lib/tools/definitions.ts — update_brief description frissítés:**

Az `update_brief` tool description-jében frissítsd a `field` property description-jét, hogy tartalmazza az összes Agency Brief mezőnevet. Ez azért fontos, mert az AI ebből a leírásból tudja, milyen mezőket rögzíthet:

```
field: {
  type: "string",
  description: "Melyik mező frissüljön. Alap mezők: company_name, contact_name, industry, brand_positioning, campaign_name, campaign_goal, main_message, creative_source, creative_types, communication_style, ad_channels, kpis, gender, location, age_range, psychographics, persona, start_date, end_date, key_events, budget_range, budget_allocation, competitors, inspiring_campaigns, existing_materials, previous_campaigns, notes. Típusspecifikus: media_specific.*, performance_specific.*, brand_specific.*, social_specific.*",
},
value: {
  // A value type-ot bővítsd: string VAGY array of strings (az ad_channels, kpis, gender, creative_source, creative_types, competitors mezők tömböt várnak)
  type: ["string", "array"],
  description: "A mező új értéke. String mezőkhöz string, tömb mezőkhöz (ad_channels, kpis, gender, creative_source, creative_types, competitors) string tömb.",
  items: { type: "string" },
},
```

A többi tool definíció (classify_campaign, suggest_quick_replies, complete_brief) VÁLTOZATLAN.

**lib/prompts/extraction.ts — bővítés az Agency Brief mezőkkel:**

Az EXTRACTION_PROMPT-ot bővítsd az Agency Brief mező-struktúrával. A prompt tömör legyen, de tartalmazza az összes mezőnevet szekciónként:

```
export const EXTRACTION_PROMPT = `A feladatod, hogy a felhasználó és az asszisztens közötti beszélgetésből kinyerd a kampány brief adatokat.

MEZŐK SZEKCIÓNKÉNT:
- Alap: company_name (kötelező), contact_name, industry, brand_positioning
- Kampány: campaign_name, campaign_goal (kötelező), main_message, communication_style, creative_source (tömb: "client"/"roiworks"), creative_types (tömb: "static"/"video")
- Csatornák: ad_channels (tömb), kpis (tömb)
- Célcsoport: gender (tömb: "female"/"male"), age_range, location, psychographics, persona
- Időzítés: start_date, end_date, key_events
- Költségvetés: budget_range, budget_allocation
- Versenytársak: competitors (tömb), inspiring_campaigns
- Egyéb: existing_materials, previous_campaigns, notes

SZABÁLYOK:
- A beszélgetés alapján töltsd ki a mezőket amennyire lehet
- Ha egy információ nem hangzott el, hagyd üresen (optional mezők) vagy adj üres tömböt (array mezők)
- Magyar kontextusban gondolkodj — a cégnevek, iparágak, helyszínek magyarul szerepeljenek
- A campaign_types mezőbe MINDEN felismert kampánytípust tedd (tömb, lehet több is)
- A típusspecifikus mezőket (media_specific, performance_specific, brand_specific, social_specific) CSAK akkor töltsd ki ha a campaign_types tartalmazza az adott típust
- Légy pontos: ne találj ki adatokat, csak azt írd amit a beszélgetésből ki lehet olvasni
- Ha a beszélgetésben tool use által rögzített adatok is vannak, azokat vedd figyelembe
`;
```
  </action>
  <verify>npx tsc --noEmit — nincs TS hiba. A TOOL_DEFINITIONS-ben az update_brief field description tartalmazza a "contact_name" és "ad_channels" szavakat. Az EXTRACTION_PROMPT tartalmazza a "brand_positioning", "persona", "start_date" szavakat.</verify>
  <done>Az update_brief tool ismeri az összes Agency Brief mezőnevet, és tömb értéket is elfogad. Az extraction prompt tartalmazza a teljes mező struktúrát szekciónként.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — nincs TS hiba az összes módosított fájlban
2. A BriefBaseSchema-ban NEM létezik a `timing` és `target_audience` mező
3. A BriefBaseSchema-ban létezik: company_name, contact_name, brand_positioning, campaign_name, main_message, ad_channels, kpis, gender, start_date, end_date, persona, budget_allocation, inspiring_campaigns (~25 mező)
4. A `lib/pdf-template.tsx` és `lib/email-template.ts` NEM tartalmaz lokális szekció definíciókat (EXECUTIVE_SUMMARY, BASE_SECTIONS) — ezeket a brief-sections.ts-ből importálja
5. A `lib/brief-sections.ts` exportálja az AGENCY_BRIEF_SECTIONS-t
6. Az update_brief tool description tartalmazza az összes Agency Brief mezőnevet
</verification>

<success_criteria>
- BriefBaseSchema ~25 Agency Brief mezővel, flat struktúra, company_name + campaign_goal kötelező, többi optional
- Szekció definíciók centralizálva brief-sections.ts-ben, pdf-template és email-template onnan importál
- update_brief tool ismeri az összes mezőnevet, tömb értéket is elfogad
- Extraction prompt tartalmazza a teljes Agency Brief mező struktúrát
- Nincs TypeScript hiba
</success_criteria>

<output>
After completion, create `.planning/phases/04-bovitett-adatgyujtes-jovahagyas/04-01-SUMMARY.md`
</output>
