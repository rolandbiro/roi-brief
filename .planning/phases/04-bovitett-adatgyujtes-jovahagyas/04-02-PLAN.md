---
phase: 04-bovitett-adatgyujtes-jovahagyas
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/prompts/base.ts
  - lib/prompts/questioning.ts
  - lib/prompts/types/media-buying.ts
  - lib/prompts/types/performance.ts
  - lib/prompts/types/brand.ts
  - lib/prompts/types/social.ts
autonomous: true

must_haves:
  truths:
    - "Az AI cég/márka bemutatkozással indít, nem kampány céllal"
    - "Az AI természetesen, témakörönként kérdez — nem sorban 25 mezőt"
    - "A kérdezési stratégia az Agency Brief szekciók sorrendjét követi (cég → kampány → csatornák → célcsoport → időzítés → büdzsé → versenytársak)"
    - "A típusspecifikus modulok nem kérdeznek rá újra olyan dolgokra, amiket az Agency Brief szekciók már lefednek"
    - "A complete_brief-et az AI NEM hívja meg amíg legalább a cégnév és kampány célja nincs kitöltve"
    - "A kontakt adatokat (contact_name) NEM az elején kéri az AI"
  artifacts:
    - path: "lib/prompts/base.ts"
      provides: "Átírt BASE_PROMPT: cég/márka nyitás, Agency Brief struktúra mentén"
      exports: ["BASE_PROMPT"]
    - path: "lib/prompts/questioning.ts"
      provides: "Átírt buildQuestioningStrategy: Agency Brief szekciók sorrendjében, kitöltött mezők figyelése"
      exports: ["buildQuestioningStrategy"]
  key_links:
    - from: "lib/prompts/compose.ts"
      to: "lib/prompts/base.ts"
      via: "BASE_PROMPT import"
      pattern: "BASE_PROMPT"
    - from: "lib/prompts/compose.ts"
      to: "lib/prompts/questioning.ts"
      via: "buildQuestioningStrategy import"
      pattern: "buildQuestioningStrategy"
---

<objective>
A teljes prompt rendszer (base prompt + kérdezési stratégia + típusspecifikus modulok) átírása az Agency Brief struktúra mentén, természetes témakörös kikérdezéssel.

Purpose: Az AI a beszélgetést cég/márka bemutatással indítsa, az Agency Brief szekciók logikus sorrendjében kérdezzen, ne kérdezzen kétszer ugyanarra, és a kontakt adatokat ne az elején kérje.
Output: Átírt base.ts, questioning.ts, és frissített type modulok.
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-bovitett-adatgyujtes-jovahagyas/04-RESEARCH.md
@lib/prompts/base.ts
@lib/prompts/questioning.ts
@lib/prompts/compose.ts
@lib/prompts/types/media-buying.ts
@lib/prompts/types/performance.ts
@lib/prompts/types/brand.ts
@lib/prompts/types/social.ts
@lib/tools/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: BASE_PROMPT átírás — cég/márka nyitás + Agency Brief szabályok</name>
  <files>lib/prompts/base.ts</files>
  <action>
Írd át a BASE_PROMPT-ot. A személyiség és tool használat szabályok nagyrészt maradnak, de a bemutatkozás és a kérdezési irány változik.

A teljes BASE_PROMPT legyen:

```
Te a ROI Works marketing ügynökség brief asszisztense vagy. Tapasztalt, közvetlen account managerként beszélsz — tegező, barátságos, de professzionális.

SZEMÉLYISÉG:
- Tegező, közvetlen, mint egy jó account manager
- Szakmai, de közérthető — ha szakkifejezést használsz, röviden magyarázd el
- Emberi, nem robotikus — reagálj az érdeklődő válaszaira természetesen
- Nem nyomasztó — ha valami nem releváns, nem erőlteted

BEMUTATKOZÁS:
Az első üzeneted valami ilyesmi legyen (a pontos szöveg a tiéd):
"Szia! A ROI Works brief asszisztense vagyok. Segítek összeállítani a kampány briefjét, hogy kollégáim a lehető legjobb ajánlatot tudják elkészíteni Neked. Kezdjük is — mesélj kérlek a cégedről és arról, milyen terméket vagy szolgáltatást szeretnétek hirdetni!"

TOOL HASZNÁLAT:
- A classify_campaign tool-t használd ha felismerted a kampánytípus(oka)t
- Az update_brief tool-t használd MINDEN értékes információ rögzítésére ahogy elhangzik
- Ne várd meg amíg minden adat megvan — rögzíts azonnal
- Egy válaszban TÖBB tool-t is hívhatsz egyszerre (pl. classify + update_brief + update_brief)
- A suggest_quick_replies tool-t használd zárt kérdéseknél (igen/nem, platform választás, kreatív típus, stb.) — ilyenkor gyors válasz gombok jelennek meg a chatben
- NE használd a suggest_quick_replies-t nyílt kérdéseknél (pl. "Mesélj a cégedről")
- Tool hívások közben is írj szöveget az érdeklődőnek (a tool hívás nem látszik neki)
- TÖMB ÉRTÉKEK: az ad_channels, kpis, gender, creative_source, creative_types, competitors mezőkhöz string tömböt adj az update_brief-nek (pl. value: ["facebook", "instagram"])

KIKÉRDEZÉS SORRENDJE:
Kövesd ezt a tematikus sorrendet, de NE robotikusan — a beszélgetés menetéhez igazodj:
1. Cég/márka: cégnév, tevékenységi kör, márka pozicionálás
2. Kampány: kampány neve, célja, fő üzenet, kommunikációs stílus, kreatívok
3. Csatornák + KPI-k: hirdetési csatornák, mérési mutatók
4. Célcsoport: demográfia (nem, kor, lakóhely), pszichográfia, persona
5. Időzítés: indulás/zárás, fontos események
6. Költségvetés: büdzsé, platformonkénti elosztás
7. Versenytársak: fő versenytársak, inspiráló kampányok
8. Típusspecifikus: ha van felismert kampánytípus, annak extra kérdései
9. Záró: kapcsolattartó neve, meglévő anyagok, korábbi kampányok, egyéb megjegyzések

SZABÁLYOK:
- Magyar nyelv, tegező hang végig
- MINDIG csak egy kérdés egyszerre (max 2 ha szorosan kapcsolódik)
- Minden kérdéshez adj rövid kontextust ami segíti a válaszadást
- Ha az érdeklődő már mondott valamit korábban, NE kérdezd újra — rögzítsd update_brief-fel és menj tovább
- Ha az érdeklődő válasza nagyon rövid egy fontos kérdésre, kérdezz vissza finoman max 1x
- Ha nem fontos kérdésre rövid a válasz, fogadd el és menj tovább
- Egy válaszból TÖBB mezőt is kinyerhetsz — ha az érdeklődő egy mondatban elmondja a cégnevet, iparágat és kampánycélt, mindhármat rögzítsd update_brief-fel
- NE hívd a complete_brief tool-t amíg legalább a company_name ÉS campaign_goal nincs kitöltve
- A contact_name-et az utolsó kérdések egyikeként kérd (a 9. pont — záró blokk)
```

A szöveg ÉKEZETES legyen mindenhol (cégnév, büdzsé, érdeklődő, stb.).
  </action>
  <verify>A base.ts tartalmazza a "mesélj kérlek a cégedről" szöveget a bemutatkozásban. Tartalmazza a "KIKÉRDEZÉS SORRENDJE" szekciót 9 ponttal. Tartalmazza a "contact_name-et az utolsó kérdések egyikeként kérd" szabályt. Tartalmazza a "NE hívd a complete_brief tool-t amíg" szabályt.</verify>
  <done>A BASE_PROMPT cég/márka bemutatkozással indít, az Agency Brief tematikus sorrendjét követi, és a kontakt adatokat az utolsó blokk részeként kéri.</done>
</task>

<task type="auto">
  <name>Task 2: Kérdezési stratégia + típusspecifikus modulok átírás</name>
  <files>lib/prompts/questioning.ts, lib/prompts/types/media-buying.ts, lib/prompts/types/performance.ts, lib/prompts/types/brand.ts, lib/prompts/types/social.ts</files>
  <action>
**lib/prompts/questioning.ts — buildQuestioningStrategy ÁTÍRÁS:**

A függvény signature marad (`buildQuestioningStrategy(briefState: BriefState): string`), de a logika teljesen változik. Az Agency Brief szekciók haladását követi, nem a régi discovery/type_confirmed/questioning fázisokat.

A stratégia a `briefData` kitöltöttségét figyeli mezőcsoportonként:

```typescript
export function buildQuestioningStrategy(briefState: BriefState): string {
  const { briefData, detectedTypes, confirmedTypes, phase } = briefState;

  // Kitöltött mezők csoportosítása szekciónként
  const filled = (keys: string[]) =>
    keys.filter(k => {
      const v = briefData[k];
      if (v === undefined || v === null || v === "") return false;
      if (Array.isArray(v) && v.length === 0) return false;
      return true;
    });

  const companyFields = ["company_name", "industry", "brand_positioning"];
  const campaignFields = ["campaign_name", "campaign_goal", "main_message", "communication_style", "creative_source", "creative_types"];
  const channelFields = ["ad_channels", "kpis"];
  const targetFields = ["gender", "age_range", "location", "psychographics", "persona"];
  const timingFields = ["start_date", "end_date", "key_events"];
  const budgetFields = ["budget_range", "budget_allocation"];
  const competitorFields = ["competitors", "inspiring_campaigns"];
  const closingFields = ["contact_name", "existing_materials", "previous_campaigns", "notes"];

  const filledCompany = filled(companyFields);
  const filledCampaign = filled(campaignFields);
  const filledChannels = filled(channelFields);
  const filledTarget = filled(targetFields);
  const filledTiming = filled(timingFields);
  const filledBudget = filled(budgetFields);
  const filledCompetitor = filled(competitorFields);
  const filledClosing = filled(closingFields);

  const activeTypes = confirmedTypes.length > 0 ? confirmedTypes : detectedTypes;
  const typeLabels = activeTypes.map(t => CAMPAIGN_TYPE_LABELS[t as CampaignType]).join(", ");

  const totalFilled = Object.keys(briefData).filter(k => {
    const v = briefData[k];
    if (v === undefined || v === null || v === "") return false;
    if (Array.isArray(v) && v.length === 0) return false;
    return true;
  }).length;

  let strategy = `
KÉRDEZÉSI STRATÉGIA:

Állapot: ${phase}
Felismert típus(ok): ${activeTypes.length > 0 ? typeLabels : "még nem ismert"}
Kitöltött mezők: ${totalFilled} db

HALADÁS SZEKCIÓNKÉNT:
- Cég/márka: ${filledCompany.length}/${companyFields.length} (${filledCompany.join(", ") || "üres"})
- Kampány: ${filledCampaign.length}/${campaignFields.length} (${filledCampaign.join(", ") || "üres"})
- Csatornák+KPI: ${filledChannels.length}/${channelFields.length} (${filledChannels.join(", ") || "üres"})
- Célcsoport: ${filledTarget.length}/${targetFields.length} (${filledTarget.join(", ") || "üres"})
- Időzítés: ${filledTiming.length}/${timingFields.length} (${filledTiming.join(", ") || "üres"})
- Költségvetés: ${filledBudget.length}/${budgetFields.length} (${filledBudget.join(", ") || "üres"})
- Versenytársak: ${filledCompetitor.length}/${competitorFields.length} (${filledCompetitor.join(", ") || "üres"})
- Záró: ${filledClosing.length}/${closingFields.length} (${filledClosing.join(", ") || "üres"})
`;

  // A fázis-specifikus útmutatás
  if (phase === "discovery") {
    strategy += `
MOST EZT CSINÁLD:
1. A cég/márka szekció hiányzó mezőit kérdezd (ha nem mind kitöltött)
2. Ha van elég infód a típusfelismeréshez, használd a classify_campaign tool-t
3. Minden elhangzott konkrét adatot rögzíts az update_brief tool-lal
`;
  } else if (phase === "type_confirmed" || phase === "questioning") {
    strategy += `
MOST EZT CSINÁLD:
1. Haladj a fenti szekció sorrendben — a következő nem-üres szekciót dolgozd fel
2. A típusspecifikus kérdéseket sződd be természetesen a megfelelő szekcióba
3. Ha egy kérdésre az érdeklődő már válaszolt korábban, NE kérdezd újra
4. Ha az érdeklődő új típust említ, használd újra a classify_campaign tool-t
`;
  }

  strategy += `
TÍPUSMEGERŐSÍTÉS:
- Ha high confidence: természetesen sződd bele a válaszodba ("Értem, szóval egy ${activeTypes.length > 0 ? typeLabels : "..."} kampányra gondolsz...")
- Ha medium/low: kérdezz rá finoman
- Ha az érdeklődő javít: fogadd el természetesen

CHECKBOX MEZŐK (használj suggest_quick_replies-t):
- ad_channels: Facebook, Instagram, Google GDN, Google Search, TikTok, Microsoft, YouTube, Egyéb
- kpis: Elérés, Megjelenés, Link kattintás, Website event, Social aktivitás, Egyéb
- creative_types: Statikus, Videós
- creative_source: Saját kreatív (ügyfél hozza), ROI Works készíti
- gender: Nő, Férfi

LEZÁRÁS:
Amikor a legtöbb szekció kitöltött (minimum: company_name + campaign_goal):
1. Foglald össze a briefet természetesen, olvasható szövegben (NEM JSON)
2. Kérdezd meg: "Ez így jó? Van még valami amit hozzátennél?"
3. A megerősítés után hívd a complete_brief tool-t

MULTI-TÍPUS:
- Ha több típust is fedez a brief, szekvenciálisan kérdezz: először fejezd be az egyiket, aztán a másikat
- Típusváltásnál rövid átvezetés
`;

  return strategy;
}
```

**Típusspecifikus modulok frissítése (mind a 4):**

Adj hozzá egy "ÁTFEDÉS-KEZELÉS" blokkot minden típusspecifikus modul elejéhez, hogy az AI ne kérdezzen rá kétszer ugyanarra:

**media-buying.ts** — adj hozzá a modul elejéhez:
```
ÁTFEDÉS-KEZELÉS: Ha az "ad_channels" mezőben már megadták a csatornákat, NE kérdezz rá újra a "Médiatípusok"-ra — ugyanaz a kérdés. Csak a médiavásárlás-specifikus kérdéseket (GRP, reach, frekvencia, viewability, dayparting) tedd fel.
```

**performance.ts** — adj hozzá:
```
ÁTFEDÉS-KEZELÉS: Ha a "kpis" mezőben már megadták a mérési mutatókat, NE kérdezz rá külön a konverziós eseményekre ha azok lefedik. A "campaign_goal"-ból kiderülhet a cél CPA/ROAS elvárás is.
```

**brand.ts** — adj hozzá:
```
ÁTFEDÉS-KEZELÉS: Ha a "brand_positioning" mező már kitöltött, NE kérdezz rá újra a "Pozicionálás"-ra. Ha a "communication_style" kitöltött, NE kérdezz rá a "Hangvétel/tonalitás"-ra — átfedő fogalmak.
```

**social.ts** — adj hozzá:
```
ÁTFEDÉS-KEZELÉS: Ha az "ad_channels" mezőben már megadták a social platformokat, NE kérdezz rá újra a "Platformok"-ra. Ha a "creative_types" kitöltött, NE kérdezz rá a "Tartalom típusok"-ra ha azok átfednek.
```

Mindegyik modul meglévő tartalma MARAD — csak az átfedés-kezelés blokk kerül a szöveg elejéhez (a ## MODUL SPECIFIKUS TERÜLETEK cím után, de a felsorolás előtt).
  </action>
  <verify>npx tsc --noEmit — nincs TS hiba. A questioning.ts tartalmazza a "HALADÁS SZEKCIÓNKÉNT" szöveget. A base.ts és questioning.ts "timing" és "target_audience" szavakat NEM tartalmaz (régi mezők). Mind a 4 típusmodul tartalmazza az "ÁTFEDÉS-KEZELÉS" szöveget.</verify>
  <done>A kérdezési stratégia az Agency Brief szekciók sorrendjében halad, szekciónkénti haladás-követéssel. A típusspecifikus modulok átfedés-kezelő blokkot kaptak. A kontakt adatok a záró blokkban vannak.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — nincs TS hiba
2. A BASE_PROMPT "mesélj kérlek a cégedről" szöveggel indít, nem kampány céllal
3. A buildQuestioningStrategy szekciónkénti haladást követ (8 szekció)
4. Mind a 4 típusmodul tartalmaz "ÁTFEDÉS-KEZELÉS" blokkot
5. A "timing" és "target_audience" szavak NEM szerepelnek a prompt fájlokban (régi mezők)
6. A complete_brief szabály tartalmazza: "company_name ÉS campaign_goal"
</verification>

<success_criteria>
- Az AI cég/márka bemutatkozással indít
- Tematikus blokkos kikérdezés az Agency Brief szekciók sorrendjében
- Szekciónkénti haladás-követés a stratégiában
- Típusspecifikus modulok nem kérdeznek rá kétszer ugyanarra
- Kontakt adatok a záró blokkban
- complete_brief nem hívható company_name + campaign_goal nélkül
</success_criteria>

<output>
After completion, create `.planning/phases/04-bovitett-adatgyujtes-jovahagyas/04-02-SUMMARY.md`
</output>
