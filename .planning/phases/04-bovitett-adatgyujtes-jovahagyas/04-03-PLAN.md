---
phase: 04-bovitett-adatgyujtes-jovahagyas
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - components/BriefEditor.tsx
  - app/brief/page.tsx
  - hooks/useChat.ts
  - app/api/approve/route.ts
  - app/api/send-brief/route.tsx
autonomous: true

must_haves:
  truths:
    - "A BriefEditor read-only összefoglalót mutat az Agency Brief szekciók szerint — nincs szerkeszthető mező, nincs email input"
    - "A 'Jóváhagyom' gomb kattintás után az /api/approve endpoint-ot hívja, nem a /api/send-brief-et"
    - "Jóváhagyás után köszönő oldal jelenik meg: 'Köszönjük!' + 'PDF letöltése' gomb + PM üzenet"
    - "A 'Vissza a chatbe' gomb visszanavigál a chat nézetbe a briefData null-ra állításával"
    - "A jóváhagyás gomb disabled-re vált kattintás után (dupla kattintás védelem)"
    - "Az /api/approve endpoint after()-rel triggereli a Phase 5 research pipeline-t (placeholder)"
    - "Az /api/send-brief route eltávolítva"
  artifacts:
    - path: "components/BriefEditor.tsx"
      provides: "Read-only jóváhagyási összefoglaló + köszönő oldal"
    - path: "app/api/approve/route.ts"
      provides: "Jóváhagyás API endpoint after() trigger-rel"
      exports: ["POST"]
    - path: "hooks/useChat.ts"
      provides: "Jóváhagyási flow state (isApproved) + approve hívás + setBriefData"
  key_links:
    - from: "components/BriefEditor.tsx"
      to: "app/api/approve/route.ts"
      via: "fetch POST /api/approve"
      pattern: "/api/approve"
    - from: "components/BriefEditor.tsx"
      to: "lib/brief-sections.ts"
      via: "getActiveSections(briefData)"
      pattern: "getActiveSections"
    - from: "app/brief/page.tsx"
      to: "hooks/useChat.ts"
      via: "useChat hook setBriefData"
      pattern: "setBriefData"
---

<objective>
BriefEditor átalakítás read-only jóváhagyási flow-vá, approve API endpoint létrehozása after() trigger-rel, köszönő oldal, és a send-brief route eltávolítása.

Purpose: Az ügyfél megtekinti az összegyűjtött adatokat, jóváhagyja, PDF-et tölt le — a session véget ér. A jóváhagyás háttérben triggereli a Phase 5 kutatást.
Output: Átírt BriefEditor + approve API + frissített brief page + useChat hook
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-bovitett-adatgyujtes-jovahagyas/04-RESEARCH.md
@.planning/phases/04-bovitett-adatgyujtes-jovahagyas/04-01-SUMMARY.md
@components/BriefEditor.tsx
@app/brief/page.tsx
@hooks/useChat.ts
@app/api/send-brief/route.tsx
@lib/brief-sections.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Approve API endpoint + send-brief eltávolítás</name>
  <files>app/api/approve/route.ts, app/api/send-brief/route.tsx</files>
  <action>
**app/api/approve/route.ts — ÚJ FÁJL:**

Hozd létre az approve API endpoint-ot. A route Next.js `after()` API-t használ a fire-and-forget trigger-hez:

```typescript
import { after } from 'next/server';

export async function POST(request: Request) {
  let briefData;
  try {
    const body = await request.json();
    briefData = body.briefData;
  } catch {
    return Response.json({ error: 'Érvénytelen kérés' }, { status: 400 });
  }

  if (!briefData?.company_name || !briefData?.campaign_goal) {
    return Response.json(
      { error: 'Cégnév és kampány célja kötelező' },
      { status: 400 }
    );
  }

  // Fire-and-forget: Phase 5 research pipeline trigger
  after(async () => {
    try {
      // Phase 5 will implement runResearchPipeline(briefData)
      console.log('[approve] Research pipeline triggered for:', briefData.company_name);
    } catch (error) {
      // Phase 6 will handle PM error notification
      console.error('[approve] Research pipeline error:', error);
    }
  });

  return Response.json({ approved: true });
}
```

Ennyi — tömör, egyszerű. A `after()` import a `next/server`-ből jön, Next.js 16-ban natívan elérhető.

**app/api/send-brief/route.tsx — TÖRLÉS:**

Töröld a fájlt teljesen. Az ügyfélnek nem küldünk emailt (döntés). A PM-nek küldött email Phase 6 scope.
  </action>
  <verify>Az app/api/approve/route.ts fájl létezik és `POST` exportja van. Az app/api/send-brief/route.tsx fájl NEM létezik. `npx tsc --noEmit` — nincs TS hiba.</verify>
  <done>Az approve API endpoint létezik after() trigger-rel. A send-brief route törölve.</done>
</task>

<task type="auto">
  <name>Task 2: BriefEditor read-only jóváhagyás + köszönő oldal + brief page flow</name>
  <files>components/BriefEditor.tsx, app/brief/page.tsx, hooks/useChat.ts</files>
  <action>
**components/BriefEditor.tsx — TELJES ÁTÍRÁS:**

A komponens 2 állapotot kezel: "review" (áttekintés + jóváhagyás) és "approved" (köszönő oldal).

Props interface változás:
```typescript
interface BriefEditorProps {
  initialData: BriefData;
  onBackToChat: () => void;  // ÚJ: visszanavigálás a chatbe
}
```

State:
```typescript
const [briefData] = useState<BriefData>(initialData);
const [isApproving, setIsApproving] = useState(false);
const [isApproved, setIsApproved] = useState(false);
const [pdfDownloading, setPdfDownloading] = useState(false);
```

ELTÁVOLÍTOTT state-ek: `clientEmail`, `isSending`, `isSuccess` — nem kell email, nem kell send-brief.

**Review állapot (isApproved === false):**

1. Fejléc:
   - "Brief áttekintése" — `text-roi-orange`
   - Alcím: "Nézd át az összegyűjtött adatokat. Ha minden rendben van, hagyd jóvá a briefet."
   - Kampánytípus badge-ek (ahogy eddig: `campaign_types` map, narancs háttér)
   - "Vissza a chatbe" gomb a fejlécben (jobb felső sarok, btn-secondary, kis méret): `onClick={onBackToChat}`

2. Szekciók: `getActiveSections(briefData)` iterálása — minden szekció egy card-ban:
   - Szekció cím narancs színnel
   - Mezők: label (text-roi-gray-light, 13px) + value (text-white, 13px) — KIZÁRÓLAG read-only
   - Checkbox mezők (ad_channels, kpis, creative_source, creative_types, gender) értékeit badge/tag formában jelenítsd meg: kis narancs/20 háttérrel, rounded-full, px-3 py-1 — ha string tömb, minden elem külön badge

3. Jóváhagyás blokk (az utolsó card):
   - "Jóváhagyás" szekció cím (narancs)
   - Rövid szöveg: "Ha az adatok rendben vannak, a Jóváhagyom gombbal véglegesítheted a briefet."
   - "Jóváhagyom" gomb (btn-primary, w-full, nagy méret py-4): `onClick={handleApprove}`
   - A gomb `disabled={isApproving}` — dupla kattintás védelem
   - Felirat isApproving közben: "Feldolgozás..."

4. handleApprove:
```typescript
const handleApprove = async () => {
  setIsApproving(true);
  try {
    const response = await fetch('/api/approve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ briefData }),
    });
    if (!response.ok) throw new Error('Approval failed');
    setIsApproved(true);
  } catch (error) {
    console.error('Error approving brief:', error);
    alert('Hiba történt a jóváhagyás során. Kérlek, próbáld újra.');
    setIsApproving(false);
  }
};
```

5. handleDownloadPdf: VÁLTOZATLAN (POST /api/download-pdf, blob letöltés, `roi-works-brief-${Date.now()}.pdf`).

**Approved állapot (isApproved === true) — köszönő oldal:**

Vizuálisan hasonló az eddigi success oldalhoz (zöld pipa animáció marad), de a szöveg változik:

- Cím: "Köszönjük!" (text-roi-orange span)
- Szöveg: "A briefet sikeresen rögzítettük. A ROI Works projekt menedzser hamarosan felveszi Veled a kapcsolatot az ajánlat részleteivel."
- "PDF letöltése" gomb (btn-primary, nagy méret) — handleDownloadPdf
- "Új brief indítása" gomb (btn-secondary) — router.push("/")
- Dekoratív elemek (3 bouncing dot) — marad ahogy eddig

NEM kell: email mező, "Jóváhagyás és küldés" gomb, send-brief API hívás.

**app/brief/page.tsx — FRISSÍTÉS:**

1. A `setBriefData` szükséges a hook-ból (ez már exportálva van a useChat-ből).

2. A "Vissza a chatbe" callback:
```typescript
const handleBackToChat = () => {
  setBriefData(null);
};
```

3. A BriefEditor rendereléskor:
```tsx
if (briefData) {
  return <BriefEditor initialData={briefData} onBackToChat={handleBackToChat} />;
}
```

4. A "Brief áttekintése" gomb szövege marad "Brief áttekintése" (ahogy van).

5. A requestExtraction logika marad (az extractBrief=true hívás).

**hooks/useChat.ts — MINIMÁLIS MÓDOSÍTÁS:**

A hook jelen állapota már exportálja a `setBriefData`-t — ez szükséges a "Vissza a chatbe" gombhoz. Az `app/brief/page.tsx` ebből destructure-öli. Ellenőrizd, hogy a return objektumban benne van a `setBriefData`.

Ha szükséges, a hook-ból eltávolíthatod a `requestExtraction` logikát, mivel az extraction most a briefState.briefData-ból jön (nem egy külön Claude hívásból). DE: a jelenlegi requestExtraction (ami a BriefDataSchema.safeParse-t futtatja szerveren) valószínűleg működik az új sémával is — HAGYD meg, ne bonyolítsd.
  </action>
  <verify>npx tsc --noEmit — nincs TS hiba. A BriefEditor.tsx NEM tartalmaz "clientEmail" state-et, NEM tartalmaz email input-ot, NEM tartalmaz "send-brief" fetch-et. A BriefEditor.tsx tartalmaz "/api/approve" fetch-et. A BriefEditor.tsx tartalmaz "onBackToChat" prop-ot. Az app/brief/page.tsx tartalmaz "setBriefData(null)" hívást a handleBackToChat-ben.</verify>
  <done>A BriefEditor read-only jóváhagyási összefoglalót mutat email nélkül. "Jóváhagyom" gomb az approve API-t hívja. Jóváhagyás után köszönő oldal jelenik meg PDF letöltéssel. "Vissza a chatbe" gomb visszanavigál a chatbe. A send-brief route törölve.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — nincs TS hiba
2. A BriefEditor NEM tartalmaz email input-ot vagy send-brief API hívást
3. A BriefEditor "Jóváhagyom" gombot mutat, nem "Jóváhagyás és küldés"-t
4. A köszönő oldalon "PDF letöltése" gomb van
5. Az /api/approve route létezik, after() trigger-t használ
6. Az /api/send-brief route NEM létezik
7. A "Vissza a chatbe" gomb a briefData-t null-ra állítja
8. `npm run build` sikeresen lefut (nincs broken import a send-brief route-ra)
</verification>

<success_criteria>
- Read-only BriefEditor (nincs email input, nincs szerkeszthető mező)
- "Jóváhagyom" gomb → /api/approve → köszönő oldal → PDF letöltés
- "Vissza a chatbe" gomb → visszanavigál a chat nézetbe
- Dupla kattintás védelem a jóváhagyom gombon
- after() trigger a Phase 5-nek (placeholder)
- send-brief route törölve
- Checkbox mezők badge/tag formában jelennek meg
</success_criteria>

<output>
After completion, create `.planning/phases/04-bovitett-adatgyujtes-jovahagyas/04-03-SUMMARY.md`
</output>
