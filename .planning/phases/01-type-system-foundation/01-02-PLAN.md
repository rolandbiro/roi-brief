---
phase: 01-type-system-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - app/api/chat/route.ts
  - hooks/useChat.ts
  - types/chat.ts
  - lib/prompts.ts
autonomous: true

must_haves:
  truths:
    - "Claude API hívás structured output-ot ad vissza (output_config.format zodOutputFormat-tal)"
    - "BRIEF_JSON_START/END regex pattern eltávolítva a teljes codebase-ből"
    - "Chat streaming továbbra is működik (free-form válasz, nincs JSON a chatben)"
    - "useChat hook az új Zod-based BriefData típust használja"
  artifacts:
    - path: "app/api/chat/route.ts"
      provides: "Streaming chat + structured extraction endpoint"
      contains: "zodOutputFormat"
    - path: "hooks/useChat.ts"
      provides: "Chat hook with new extraction flow"
      contains: "BriefData.*from.*@/types/brief"
    - path: "package.json"
      provides: "Updated dependencies"
      contains: "zod"
  key_links:
    - from: "app/api/chat/route.ts"
      to: "lib/schemas/brief-data.ts"
      via: "zodOutputFormat(BriefDataSchema)"
      pattern: "zodOutputFormat.*BriefDataSchema"
    - from: "app/api/chat/route.ts"
      to: "lib/prompts/compose.ts"
      via: "composeSystemPrompt import"
      pattern: "composeSystemPrompt"
    - from: "hooks/useChat.ts"
      to: "types/brief.ts"
      via: "BriefData import"
      pattern: "import.*BriefData.*from.*@/types/brief"
---

<objective>
SDK upgrade, chat API route átírása structured output-ra, és useChat hook refactorálása.

Purpose: A törékeny BRIEF_JSON_START/END regex pattern-t lecseréljük Anthropic structured outputs-ra (zodOutputFormat). A chat API route dual-call pattern-re vált: streaming a beszélgetéshez, külön non-streaming hívás az adatkinyeréshez. Az SDK 0.71.2-ről 0.74.0-ra upgrade-el.

Output: Működő chat API route structured output-tal, refactored useChat hook, frissített dependencies.
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-type-system-foundation/01-RESEARCH.md
@.planning/phases/01-type-system-foundation/01-01-SUMMARY.md
@app/api/chat/route.ts
@hooks/useChat.ts
@types/chat.ts
@lib/prompts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dependencies frissítése és régi kód eltávolítása</name>
  <files>
    package.json
    lib/prompts.ts
    types/chat.ts
  </files>
  <action>
**1. Dependencies:**
```bash
npm install zod @anthropic-ai/sdk@latest
npm uninstall ai pdf-parse unpdf
```

Ellenőrizd hogy:
- `zod` >= 4.x települt
- `@anthropic-ai/sdk` >= 0.74.0 települt
- `ai`, `pdf-parse`, `unpdf` eltávolítva a package.json-ból

**2. Régi lib/prompts.ts törlése:**
- Töröld a `lib/prompts.ts` fájlt teljes egészében (az új prompt rendszer `lib/prompts/` mappában van Plan 01-ből)

**3. types/chat.ts átalakítása:**
- Töröld a `BriefData` interface-t a `types/chat.ts`-ből (az új BriefData a `types/brief.ts`-ben van Plan 01-ből)
- A `Message` interface MARAD a `types/chat.ts`-ben, ez nem változik
  </action>
  <verify>
`npm ls zod @anthropic-ai/sdk` -- mindkettő listázva, helyes verzióval.
`npm ls ai pdf-parse unpdf 2>&1` -- nem találhatók (eltávolítva).
`cat types/chat.ts` -- csak Message interface van benne, BriefData nincs.
`ls lib/prompts.ts` -- nem létezik (törölve).
  </verify>
  <done>
Zod v4 és @anthropic-ai/sdk 0.74.0+ telepítve. ai, pdf-parse, unpdf eltávolítva. Régi prompts.ts törölve. BriefData interface törölve a types/chat.ts-ből, Message interface megmaradt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Chat API route átírása dual-call pattern-re + structured output</name>
  <files>
    app/api/chat/route.ts
  </files>
  <action>
Írd át az `app/api/chat/route.ts`-t teljesen:

**Request interface:**
```typescript
interface ChatRequest {
  messages: Array<{ role: "user" | "assistant"; content: string }>;
  campaignTypes?: string[];  // detektált kampánytípusok (Phase 2-ben jön, egyelőre opcionális)
  extractBrief?: boolean;    // true ha brief extraction-t is kérünk
}
```

**Streaming chat (minden request-nél):**
- Import `composeSystemPrompt` from `@/lib/prompts`
- Import `CampaignType` from `@/lib/schemas`
- A system prompt: `composeSystemPrompt(campaignTypes as CampaignType[] || [])` -- ha nincsenek típusok, csak base prompt
- Streaming response SSE formátumban (megtartva a jelenlegi SSE pattern-t)
- Modell: `claude-sonnet-4-20250514` (marad)
- NE legyen `output_config` a streaming hívásban -- ez free-form chat

**Brief extraction (ha extractBrief === true):**
- A streaming válasz UTÁN, ha `extractBrief` true:
- Külön non-streaming hívás `output_config: { format: zodOutputFormat(BriefDataSchema) }` -tal
- Import `zodOutputFormat` from `@anthropic-ai/sdk/helpers/zod`
- Import `BriefDataSchema` from `@/lib/schemas`
- Import `EXTRACTION_PROMPT` from `@/lib/prompts`
- System prompt: EXTRACTION_PROMPT
- Messages: a teljes konverzációs history + egy záró user message: "Kérlek, foglald össze a brief adatokat a beszélgetés alapján."
- A response JSON-t parse-old `BriefDataSchema.parse()`-al
- Az extraction eredményt a stream végén küldd el egy speciális SSE event-ként: `data: ${JSON.stringify({ briefData: parsedData })}\n\n`
- Ha az extraction fail-el (pl. még nincs elég adat), ne dobd el a hibát -- logold és folytasd (a chat stream már elment)

**SSE format (pontosítás):**
- Chat text chunk: `data: {"text":"..."}\n\n`
- Brief extraction result: `data: {"briefData":{...}}\n\n`
- Stream end: `data: [DONE]\n\n`

**Error handling:**
- A meglévő error handling pattern-t tartsd meg (try/catch, 500 response)
- Az extraction error NE törje el a chat stream-et
  </action>
  <verify>
`npx tsc --noEmit` -- hiba nélkül fordul.
`curl -X POST http://localhost:3000/api/chat -H "Content-Type: application/json" -d '{"messages":[{"role":"user","content":"Szia, szeretnék egy kampány briefet összeállítani."}]}'` -- streaming válasz jön vissza SSE formátumban.
  </verify>
  <done>
Chat API route dual-call pattern-nel működik. Streaming chat composeSystemPrompt()-tal. Brief extraction zodOutputFormat(BriefDataSchema)-val. BRIEF_JSON_START/END pattern nincs a kódban.
  </done>
</task>

<task type="auto">
  <name>Task 3: useChat hook refactorálása az új API-hoz</name>
  <files>
    hooks/useChat.ts
  </files>
  <action>
Refactorld a `hooks/useChat.ts`-t:

**Import változások:**
- Cseréld `import { BriefData } from "@/types/chat"` -t `import { BriefData } from "@/types/brief"` -re
- Töröld a `createInitialMessage` importot (a régi lib/prompts.ts már nincs)

**checkForBriefData eltávolítása:**
- Töröld a teljes `checkForBriefData` függvényt (ez a BRIEF_JSON_START/END regex volt)

**processStream frissítése:**
- A processStream-ben kezeld az új SSE event formátumot:
  - Ha `parsed.text` van: streaming text (mint eddig)
  - Ha `parsed.briefData` van: tárold el a briefData-t setBriefData()-val
- A processStream return type legyen `{ content: string; briefData: BriefData | null }`

**startChat átírása:**
- Távolítsd el a `pdfBase64` és `pdfText` paramétereket -- nincs többé PDF
- Új signature: `startChat()` paraméter nélkül
- Az első üzenet NEM PDF-alapú -- helyette a chat egyből indul, az AI bemutatkozik (a system prompt-ban van a bemutatkozás)
- Az első request-et NE user message-ként küldd -- a system prompt tartalmazza a bemutatkozást, az AI az első assistant message-ben fog bemutatkozni
- Tehát: küldj egy üres messages tömböt VAGY egy rövid user message-t (pl. "Szia!") hogy az AI válaszolhasson
- A régi `createInitialMessage(pdfText)` hívás törlendő
- Ha processStream briefData-t ad vissza, tárold el

**sendMessage:**
- Marad nagyjából ugyanaz, de:
  - A checkForBriefData hívást töröld (a processStream most kezeli)
  - Ha processStream briefData-t ad vissza, tárold el

**Új: requestExtraction függvény (opcionális, készíts elő Phase 2-re):**
- `requestExtraction()` -- külön hívás `extractBrief: true` flaggel
- Ez a beszélgetés végén hívódik majd (Phase 2 fogja bekötni)
- Most exportáld mint publikus API-t a hook-ból

**Return érték bővítése:**
- Adj hozzá `requestExtraction` -t az exportált objektumhoz
  </action>
  <verify>
`npx tsc --noEmit` -- hiba nélkül fordul.
A hook exportálja: messages, isLoading, streamingContent, briefData, error, startChat, sendMessage, setBriefData, requestExtraction.
Grep: nincs "BRIEF_JSON_START" vagy "checkForBriefData" a hooks/useChat.ts-ben.
  </verify>
  <done>
useChat hook az új BriefData típust használja types/brief.ts-ből. BRIEF_JSON_START/END regex eltávolítva. processStream kezeli a briefData SSE event-et. startChat() paraméter nélküli (nincs PDF). requestExtraction() előkészítve.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- Teljes TypeScript fordítás hiba nélkül
2. `npm run build` -- Next.js build sikerül
3. Grep: `BRIEF_JSON_START` -- 0 találat a teljes codebase-ben (kivéve .planning/)
4. Grep: `pdf-parse\|unpdf` -- 0 találat a package.json dependencies-ben
5. Grep: `zodOutputFormat` -- megtalálható app/api/chat/route.ts-ben
6. Grep: `composeSystemPrompt` -- megtalálható app/api/chat/route.ts-ben
</verification>

<success_criteria>
- Anthropic SDK 0.74.0+ telepítve (TECH-04)
- Structured output zodOutputFormat-tal (TECH-02)
- BRIEF_JSON_START/END regex eltávolítva a codebase-ből (TECH-02)
- Moduláris prompt compose a chat route-ban (TECH-03)
- ai, pdf-parse, unpdf eltávolítva (FLOW-02 részben)
- useChat hook az új típusrendszert használja (TECH-05)
</success_criteria>

<output>
After completion, create `.planning/phases/01-type-system-foundation/01-02-SUMMARY.md`
</output>
