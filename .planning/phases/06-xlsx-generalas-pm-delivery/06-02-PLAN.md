---
phase: 06-xlsx-generalas-pm-delivery
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - lib/delivery/send-pm-email.ts
  - lib/delivery/send-error-email.ts
  - app/api/approve/route.ts
  - app/api/retry/[token]/route.ts
  - next.config.ts
  - .env.example
autonomous: true
user_setup:
  - service: sendgrid
    why: "PM email küldés"
    env_vars:
      - name: PM_EMAIL
        source: "A PM email címe, ahova a kitöltött xlsx-et küldjük"
      - name: PM_CC_EMAILS
        source: "Opcionális CC címek vesszővel elválasztva"
    dashboard_config:
      - task: "info@valueonboard.com feladó verifikálás"
        location: "SendGrid Dashboard -> Sender Authentication (Single Sender Verification vagy Domain Authentication)"

must_haves:
  truths:
    - "A PM emailben megkapja a kombinált xlsx-et mellékletként az approve flow végén"
    - "Az email tartalmaz rövid összefoglalót (ügyfél neve, kampány cél, büdzsé, időszak) és kutatási forrásokat"
    - "Ha a pipeline hibára fut, a PM hibaértesítést kap emailben (melyik lépés bukott, retry link)"
    - "Részleges siker esetén ami elkészült, azt elküldi, és jelzi mi hiányzik"
    - "A retry link újra futtatja a feldolgozást"
  artifacts:
    - path: "lib/delivery/send-pm-email.ts"
      provides: "Sikeres xlsx delivery email küldés"
      exports: ["sendPmEmail"]
    - path: "lib/delivery/send-error-email.ts"
      provides: "Hiba email küldés retry linkkel"
      exports: ["sendErrorEmail"]
    - path: "app/api/retry/[token]/route.ts"
      provides: "Retry endpoint a feldolgozás újraindításához"
      exports: ["POST"]
    - path: "app/api/approve/route.ts"
      provides: "Kibővített approve route: pipeline → xlsx → email"
    - path: "next.config.ts"
      provides: "outputFileTracingIncludes az xlsx template fájlokhoz"
  key_links:
    - from: "app/api/approve/route.ts"
      to: "lib/xlsx/fill-agency-brief.ts"
      via: "import + await fillAgencyBrief()"
      pattern: "fillAgencyBrief|fillMediaplan|combineWorkbooks"
    - from: "app/api/approve/route.ts"
      to: "lib/delivery/send-pm-email.ts"
      via: "import + await sendPmEmail()"
      pattern: "sendPmEmail|sendErrorEmail"
    - from: "lib/delivery/send-pm-email.ts"
      to: "@sendgrid/mail"
      via: "sgMail.send with attachment"
      pattern: "sgMail\\.send|attachments.*base64"
    - from: "app/api/retry/[token]/route.ts"
      to: "app/api/approve/route.ts"
      via: "Retry flow: decode token → re-run pipeline"
      pattern: "runResearchPipeline|briefData"
---

<objective>
Delivery pipeline: approve route kibővítése xlsx generálással és PM email küldéssel, error handling retry linkkel.

Purpose: A Phase 6 pipeline végső lépése — a Plan 01-ben létrehozott xlsx generálás és a meglévő research pipeline összekapcsolása a PM email delivery-vel. A PM megkapja a kitöltött xlsx-et, hiba esetén értesítést kap retry lehetőséggel.
Output: Email delivery modulok + approve route teljes pipeline bekötés + retry endpoint + Vercel config.
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-xlsx-generalas-pm-delivery/06-RESEARCH.md
@.planning/phases/06-xlsx-generalas-pm-delivery/06-01-SUMMARY.md
@lib/xlsx/fill-agency-brief.ts
@lib/xlsx/fill-mediaplan.ts
@lib/xlsx/combine-workbook.ts
@app/api/approve/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Email delivery modulok + retry endpoint</name>
  <files>
    lib/delivery/send-pm-email.ts
    lib/delivery/send-error-email.ts
    app/api/retry/[token]/route.ts
    .env.example
  </files>
  <action>
1. Hozd létre `lib/delivery/send-pm-email.ts`:
   - `sendPmEmail(briefData: BriefData, research: ResearchResults, xlsxBuffer: Buffer): Promise<void>`
   - SendGrid: `sgMail.setApiKey(process.env.SENDGRID_API_KEY!)`
   - Feladó: `info@valueonboard.com`
   - Címzett: `process.env.PM_EMAIL!`
   - CC: `process.env.PM_CC_EMAILS?.split(',').map(e => e.trim()).filter(Boolean)` — ha üres, undefined (nem üres tömb)
   - Subject: `Új brief: ${companyName} — ${campaignName}` (ha campaign_name üres, `${companyName} kampány`)
   - Body plain text (NEM HTML), 3-5 sor összefoglaló:
     - Ügyfél neve, kampány neve, kampány cél, büdzsé, időszak
     - Kutatási források (URL-ek listája a research.sources-ból)
     - Záró sor: "A kitöltött Agency Brief és Mediaplan xlsx csatolva."
   - Attachment: `{ content: xlsxBuffer.toString('base64'), filename: '${companyName}-brief-mediaplan.xlsx', type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', disposition: 'attachment' }`

2. Hozd létre `lib/delivery/send-error-email.ts`:
   - `sendErrorEmail(briefData: BriefData, failedStep: string, errorMessage: string, partialXlsx?: Buffer): Promise<void>`
   - Feladó: `info@valueonboard.com`, Címzett: `PM_EMAIL`, CC: `PM_CC_EMAILS`
   - Subject: `⚠ Brief hiba: ${companyName} — ${campaignName}`
   - Body plain text, közepes részletesség:
     - Melyik lépés bukott el (kutatás / xlsx generálás / email küldés)
     - Hibaüzenet röviden
     - Mi a teendő
     - Retry link: `${process.env.NEXT_PUBLIC_APP_URL}/api/retry/${retryToken}`
   - `retryToken` paraméter: a hívó adja át (nem ez a modul generálja)
   - Ha `partialXlsx` buffer van (részleges siker): csatolja mellékletként
   - **Retry token generálás:** A retry token = briefData JSON base64url-encoded string (nem in-memory store, nem kell state). Ez a legegyszerűbb serverless-kompatibilis megoldás.

3. Hozd létre `app/api/retry/[token]/route.ts`:
   - POST handler: a `[token]` URL param = base64url-encoded briefData JSON
   - Dekódolás: `Buffer.from(token, 'base64url').toString('utf8')` → JSON.parse → briefData
   - Validálás: briefData.company_name és briefData.campaign_goal létezik
   - Hívja a teljes pipeline-t: research → xlsx → email (importálja a szükséges modulokat)
   - `maxDuration = 120` (ugyanaz mint az approve route)
   - Hiba esetén: 500 JSON válasz az error message-gel
   - Siker: `{ success: true, message: 'Feldolgozás újraindítva' }`

4. Frissítsd `.env.example`-t:
   - Add hozzá: `PM_EMAIL=pm@roi.works`
   - Add hozzá: `PM_CC_EMAILS=` (üres — opcionális)
  </action>
  <verify>
    - `npx tsc --noEmit` — nincs TypeScript hiba
    - `ls lib/delivery/send-pm-email.ts lib/delivery/send-error-email.ts app/api/retry/*/route.ts` — fájlok léteznek
    - `grep PM_EMAIL .env.example` — env var dokumentálva
  </verify>
  <done>
    - sendPmEmail elküldi az xlsx-et a PM-nek plain text összefoglalóval és kutatási forrásokkal
    - sendErrorEmail elküldi a hiba értesítést retry linkkel, opcionálisan részleges xlsx-szel
    - Retry endpoint dekódolja a briefData-t és újrafuttatja a teljes pipeline-t
    - PM_EMAIL és PM_CC_EMAILS env var-ok dokumentálva
  </done>
</task>

<task type="auto">
  <name>Task 2: Approve route teljes pipeline bekötés + Vercel config</name>
  <files>
    app/api/approve/route.ts
    next.config.ts
  </files>
  <action>
1. Írd át `app/api/approve/route.ts` — a jelenlegi fire-and-forget `after()` callback-et bővítsd ki a teljes pipeline-nal:
   - Import: fillAgencyBrief, fillMediaplan, combineWorkbooks, sendPmEmail, sendErrorEmail
   - Az after() callback-ben:
     ```
     Step 1: Research pipeline futtatás (már megvan)
     Step 2: Agency Brief xlsx generálás — fillAgencyBrief(briefData)
     Step 3: Mediaplan xlsx generálás — fillMediaplan(results, briefData)
     Step 4: Kombinálás — combineWorkbooks(briefBuffer, mediaplanBuffer)
     Step 5: PM email küldés — sendPmEmail(briefData, results, combinedBuffer)
     ```
   - **Error handling:**
     - Retry token generálás: `Buffer.from(JSON.stringify(briefData)).toString('base64url')`
     - Ha a research pipeline bukik: sendErrorEmail(briefData, 'Kutatás', error.message, undefined, retryToken)
     - Ha az xlsx generálás bukik: sendErrorEmail(briefData, 'XLSX generálás', error.message, undefined, retryToken)
     - Ha az email küldés bukik: console.error + NEM küldünk error emailt (infinite loop lenne)
   - **Részleges siker:** Ha a research sikerül de az xlsx bukik → sendErrorEmail-ben nincs partial xlsx. Ha a research + xlsx sikerül de a combine bukik → sendErrorEmail-ben az agency brief xlsx-t csatolhatjuk partialXlsx-ként.
   - Tartsd meg a `maxDuration = 120`-at

2. Frissítsd `next.config.ts`:
   - Adj hozzá `outputFileTracingIncludes`-t a docs/ROI_Mediaplan xlsx fájlok Vercel deployment-éhez:
     ```typescript
     const nextConfig: NextConfig = {
       outputFileTracingIncludes: {
         '/api/approve': ['./docs/ROI_Mediaplan/**/*'],
         '/api/retry/*': ['./docs/ROI_Mediaplan/**/*'],
       },
     };
     ```
   - Ez szükséges, mert a Vercel Node File Trace nem ismeri fel a dinamikus path-okat az `fs.readFileSync` hívásokban
  </action>
  <verify>
    - `npx tsc --noEmit` — nincs TypeScript hiba
    - `grep -c 'fillAgencyBrief\|fillMediaplan\|combineWorkbooks\|sendPmEmail\|sendErrorEmail' app/api/approve/route.ts` — legalább 5 import/használat
    - `grep 'outputFileTracingIncludes' next.config.ts` — Vercel config megvan
  </verify>
  <done>
    - Az approve route a teljes pipeline-t futtatja: research → xlsx → combine → email
    - Hiba esetén a PM error emailt kap retry linkkel
    - A Vercel deployment tartalmazza az xlsx template fájlokat
    - A teljes Phase 6 pipeline end-to-end működik
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — a teljes projekt fordítható
- Az approve route tartalmazza az összes import-ot (xlsx + delivery modulok)
- A next.config.ts tartalmazza az outputFileTracingIncludes-t
- Az .env.example tartalmazza a PM_EMAIL és PM_CC_EMAILS változókat
- A retry endpoint dekódolja a base64url token-t és újrafuttatja a pipeline-t
</verification>

<success_criteria>
- A PM email küldés működik: xlsx melléklet + plain text összefoglaló + sources
- Hiba esetén a PM error emailt kap a failed step megnevezésével és retry linkkel
- A retry link újraindítja a teljes feldolgozást
- A Vercel-en az xlsx template fájlok elérhetők
- Az approve route a teljes pipeline-t futtatja fire-and-forget after() callback-ben
</success_criteria>

<output>
After completion, create `.planning/phases/06-xlsx-generalas-pm-delivery/06-02-SUMMARY.md`
</output>
