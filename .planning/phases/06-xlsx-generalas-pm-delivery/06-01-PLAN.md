---
phase: 06-xlsx-generalas-pm-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/xlsx/template-paths.ts
  - lib/xlsx/fill-agency-brief.ts
  - lib/xlsx/fill-mediaplan.ts
  - lib/xlsx/combine-workbook.ts
autonomous: true

must_haves:
  truths:
    - "Az Agency Brief xlsx tartalmazza az ügyfél által megadott összes adatot a megfelelő cellákban"
    - "A Mediaplan xlsx tartalmazza az AI kutatás channel mix sorait a template típusnak megfelelő metrikákkal"
    - "A két sheet egy kombinált xlsx fájlban jelenik meg (Agency Brief + Mediaplan sheet-ek)"
    - "Az xlsx generálás megőrzi az eredeti template formázását (merged cells, stílusok)"
  artifacts:
    - path: "lib/xlsx/template-paths.ts"
      provides: "Template fájl útvonalak és fájlnevek"
    - path: "lib/xlsx/fill-agency-brief.ts"
      provides: "Agency Brief template kitöltő függvény"
      exports: ["fillAgencyBrief"]
    - path: "lib/xlsx/fill-mediaplan.ts"
      provides: "Mediaplan template kitöltő függvény (4 variáns)"
      exports: ["fillMediaplan"]
    - path: "lib/xlsx/combine-workbook.ts"
      provides: "Két workbook kombinálása egy xlsx-be"
      exports: ["combineWorkbooks"]
  key_links:
    - from: "lib/xlsx/fill-agency-brief.ts"
      to: "BriefData schema"
      via: "import type { BriefData }"
      pattern: "brief\\.company_name|brief\\.campaign_goal"
    - from: "lib/xlsx/fill-mediaplan.ts"
      to: "ResearchResults types"
      via: "import type { ResearchResults }"
      pattern: "research\\.channels|research\\.targeting"
    - from: "lib/xlsx/combine-workbook.ts"
      to: "ExcelJS worksheet.model"
      via: "model copy + mergeCells assign"
      pattern: "worksheet\\.model.*merges"
---

<objective>
ExcelJS-alapú xlsx template kitöltés: Agency Brief + Mediaplan generálás és kombinálás egy xlsx-be.

Purpose: A Phase 5 research pipeline eredményeit és a brief adatokat programmatikusan xlsx template-ekbe kell írni — ez az xlsx generálás core logikája, amit a Plan 02 delivery pipeline fog felhasználni.
Output: 4 lib fájl (template-paths, fill-agency-brief, fill-mediaplan, combine-workbook) + ExcelJS dependency.
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-xlsx-generalas-pm-delivery/06-RESEARCH.md
@.planning/phases/05-ai-hatterkutatas/05-01-SUMMARY.md
@lib/research/types.ts
@lib/schemas/brief-base.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ExcelJS telepítés + template paths + Agency Brief fill</name>
  <files>
    lib/xlsx/template-paths.ts
    lib/xlsx/fill-agency-brief.ts
    package.json
  </files>
  <action>
1. `npm install exceljs@4.4.0`

2. Hozd létre `lib/xlsx/template-paths.ts`:
   - TEMPLATE_DIR = `path.join(process.cwd(), 'docs', 'ROI_Mediaplan')`
   - TEMPLATE_FILES map a template nevekhez:
     - agency_brief: `'ROIworks _ TEMPLATE_ Agency campaign brief.xlsx'`
     - ppc_traffic: `'ROIworks _ TEMPLATE_ Mediaplan PPC only, Traffic only 2026.xlsx'`
     - ppc_reach: `'ROIworks _ TEMPLATE_ Mediaplan PPC only, Reach only 2026.xlsx'`
     - ppc_mixed: `'ROIworks _ TEMPLATE_ Mediaplan PPC only, Traffic & Reach 2026.xlsx'`
     - all_channels: `'ROIworks _ TEMPLATE_ Mediaplan all channels.xlsx'`
   - `getTemplatePath(name)` helper ami `path.join(TEMPLATE_DIR, TEMPLATE_FILES[name])`-ot ad vissza

3. Hozd létre `lib/xlsx/fill-agency-brief.ts`:
   - `fillAgencyBrief(briefData: BriefData): Promise<Buffer>` — template betöltés `fs.readFileSync` + `wb.xlsx.load(buffer)`-rel, cellák kitöltése, `writeBuffer()` visszaadás.
   - Cella mapping a 06-RESEARCH.md "Agency Brief Template Mapping" alapján:
     - B7: company_name, B9: contact_name, B13: industry, B15: brand_positioning
     - B19: campaign_name, B21: campaign_goal, B23: main_message
     - C25/C26: creative_source (boolean: includes 'client'/'agency')
     - B28: communication_style
     - C30-E33: ad_channels checkbox-ok (Facebook ads, Instagram ads, Google GDN, Google Search, Tiktok ads, Microsoft ads, YouTube ads)
     - B37: campaign_goal
     - C39-E40: kpis checkbox-ok (Elérés, Website event, Megjelenés, Social aktivitás, Link kattintás)
     - C46/E46: gender checkbox-ok (Nő/Férfi)
     - C47: location, C48: age_range
     - B50: psychographics, B52: persona
     - B56: start_date, B58: end_date, B60: key_events
   - Ha egy mező undefined/missing → ne írd felül (üres marad)
   - A boolean checkbox cellákhoz: `ws.getCell('X').value = true/false` — a linked cell értéke frissíti a checkboxot
  </action>
  <verify>
    - `npx tsc --noEmit` — nincs TypeScript hiba
    - `node -e "const ExcelJS = require('exceljs'); console.log('ExcelJS OK')"` — ExcelJS importálható
    - `ls lib/xlsx/template-paths.ts lib/xlsx/fill-agency-brief.ts` — fájlok léteznek
  </verify>
  <done>
    - ExcelJS telepítve, template-paths és fill-agency-brief modul kész
    - fillAgencyBrief a BriefData alapján kitölti az Agency Brief template összes releváns celláját
  </done>
</task>

<task type="auto">
  <name>Task 2: Mediaplan fill (4 variáns) + combine workbook</name>
  <files>
    lib/xlsx/fill-mediaplan.ts
    lib/xlsx/combine-workbook.ts
  </files>
  <action>
1. Hozd létre `lib/xlsx/fill-mediaplan.ts`:
   - `fillMediaplan(research: ResearchResults, briefData: BriefData): Promise<Buffer>` — a `research.template_type` alapján kiválasztja a template-et, betölti, kitölti, buffer-t ad vissza.
   - A research.template_type `MediaplanTemplate` típus: 'ppc_traffic' | 'ppc_reach' | 'ppc_mixed' | 'all_channels'
   - Template betöltés `getTemplatePath(research.template_type)` + `fs.readFileSync` + `wb.xlsx.load(buffer)`

   **PPC Traffic kitöltés** (Sheet1):
   - Header: E3=campaign_name, E4=campaign_period, E5=total_budget_huf, J3=company_name, J4=campaign_goal, J5=contact_name
   - PPC Channel Mix R11-től: A=campaign_target, B=campaign_type, C=ad_network, D=ad_type, E=campaign_period
   - Metrikák: F=impressions.likely, G=ctr.likely, H=clicks.likely, I=cpc.likely, J=budget_allocation_huf, K=budget_allocation_huf
   - Ha kevesebb channel van mint 3 placeholder sor: a maradék sorok üresek maradnak (ne írj beléjük)
   - Ha több channel van: max 3 sort tölts ki (template limitáció)
   - Targeting R19-től: A=ad_network, B=age, C=gender, D=location, E=interest

   **PPC Reach kitöltés** (Sheet1):
   - Ugyanaz a header mint Traffic
   - PPC Channel Mix R11-R14 (4 sor): Metrikák: F=impressions.likely, G=frequency.likely, H=reach.likely, I=cpm.likely, J=budget_allocation_huf
   - Targeting R17-R21

   **PPC Mixed kitöltés** (Sheet1):
   - Header ugyanaz
   - Reach blokk R9-R15: reach metrikák (impressions, frequency, reach, cpm)
   - Traffic blokk R18-R23: traffic metrikák (impressions, ctr, clicks, cpc)
   - A channels tömböt szét kell bontani: reach-típusú (frequency/reach metrákikal) és traffic-típusú (ctr/clicks metrikákkal) csatornák
   - Targeting R27-R31

   **All Channels kitöltés** (Media_plan sheet):
   - PPC Marketing R11-R20: Metrikák: Megjelenés, Kattintás, Conversion/Lead, CPM/CPC/CPT, Teljes ár
   - A research.channels-ből töltjük — max 10 sor
   - Targeting adatok nem külön blokkban vannak

   **Minden variánsban:** A KPI értékeknél a `likely` értéket írd a fő oszlopba. A Min|Likely|Max döntés a template jelenlegi struktúráját nem módosítja — a "likely" megy a meglévő oszlopba, mert a template-eket nem módosítjuk kódból. (A template-ek módosítása manuális feladat.)

2. Hozd létre `lib/xlsx/combine-workbook.ts`:
   - `combineWorkbooks(briefBuffer: Buffer, mediaplanBuffer: Buffer): Promise<Buffer>` — létrehoz egy üres workbook-ot, hozzáadja mindkét sheet-et `worksheet.model` copy-val
   - FONTOS: A merged cells-t explicit kell kezelni: `Object.assign({}, source.model, { mergeCells: source.model.merges })`
   - Sheet nevek: 'Agency Brief' és 'Mediaplan'
   - Visszaad buffer-t `writeBuffer()`-rel
  </action>
  <verify>
    - `npx tsc --noEmit` — nincs TypeScript hiba
    - `ls lib/xlsx/fill-mediaplan.ts lib/xlsx/combine-workbook.ts` — fájlok léteznek
  </verify>
  <done>
    - fillMediaplan 4 template variánst kezel és a ResearchResults alapján tölti ki a megfelelő cellákat
    - combineWorkbooks két buffer-ből egy kombinált xlsx-et generál (Agency Brief + Mediaplan sheet)
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` — teljes projekt hiba nélkül fordítható
- `node -e "const ExcelJS = require('exceljs'); console.log('OK')"` — ExcelJS elérhető
- 4 fájl létezik: lib/xlsx/template-paths.ts, fill-agency-brief.ts, fill-mediaplan.ts, combine-workbook.ts
- Mindegyik fájl exportálja a megfelelő függvényt
</verification>

<success_criteria>
- ExcelJS 4.4.0 telepítve
- Az xlsx generálás logika kész: Agency Brief + 4 Mediaplan variáns + combine
- A kód `npx tsc --noEmit`-tel fordítható
</success_criteria>

<output>
After completion, create `.planning/phases/06-xlsx-generalas-pm-delivery/06-01-SUMMARY.md`
</output>
