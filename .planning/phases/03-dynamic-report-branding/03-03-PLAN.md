---
phase: 03-dynamic-report-branding
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - app/api/download-pdf/route.tsx
  - app/api/send-brief/route.tsx
  - lib/email-template.ts
autonomous: true

must_haves:
  truths:
    - "A PDF letöltés endpoint működik és PDF fájlt ad vissza"
    - "Az email csak a ROI Works csapatnak megy (nem az érdeklődőnek)"
    - "Az email HTML a flat BriefData sémát használja"
    - "Az email dinamikus szekciókat tartalmaz a kampánytípus alapján"
    - "A send-brief route a flat BriefData sémát használja (nincs TS hiba)"
  artifacts:
    - path: "app/api/download-pdf/route.tsx"
      provides: "PDF letöltés API endpoint"
      exports: ["POST"]
    - path: "app/api/send-brief/route.tsx"
      provides: "Email küldés API endpoint (csak ROI Works-nek)"
      exports: ["POST"]
    - path: "lib/email-template.ts"
      provides: "Dinamikus email HTML template flat sémával"
      exports: ["generateEmailHtml"]
  key_links:
    - from: "app/api/download-pdf/route.tsx"
      to: "lib/pdf-template.tsx"
      via: "BriefPDF import + renderToBuffer"
      pattern: "renderToBuffer.*BriefPDF"
    - from: "app/api/send-brief/route.tsx"
      to: "lib/email-template.ts"
      via: "generateEmailHtml(briefData)"
      pattern: "generateEmailHtml"
    - from: "app/api/send-brief/route.tsx"
      to: "lib/pdf-template.tsx"
      via: "BriefPDF import + renderToBuffer"
      pattern: "renderToBuffer.*BriefPDF"
    - from: "components/BriefEditor.tsx"
      to: "app/api/download-pdf/route.tsx"
      via: "fetch('/api/download-pdf')"
      pattern: "api/download-pdf"
    - from: "components/BriefEditor.tsx"
      to: "app/api/send-brief/route.tsx"
      via: "fetch('/api/send-brief')"
      pattern: "api/send-brief"
---

<objective>
PDF letöltés API endpoint + send-brief és email template átírás flat sémára.

Purpose: A jóváhagyás gomb email-t küld a ROI Works-nek (nem az érdeklődőnek), és a PDF letöltés gomb PDF-et generál. Ez a végleges delivery flow.
Output: app/api/download-pdf/route.tsx + átírt app/api/send-brief/route.tsx + átírt lib/email-template.ts
</objective>

<execution_context>
@/Users/biroroland/.claude/get-shit-done/workflows/execute-plan.md
@/Users/biroroland/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dynamic-report-branding/03-RESEARCH.md
@.planning/phases/03-dynamic-report-branding/03-01-SUMMARY.md
@.planning/phases/03-dynamic-report-branding/03-02-SUMMARY.md
@app/api/send-brief/route.tsx
@lib/email-template.ts
@lib/pdf-template.tsx
@types/brief.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: PDF letöltés API endpoint</name>
  <files>app/api/download-pdf/route.tsx</files>
  <action>
Hozd létre az `app/api/download-pdf/route.tsx` fájlt:

1. Import: renderToBuffer from @react-pdf/renderer, BriefPDF from @/lib/pdf-template.

2. `export async function POST(request: Request)`:
   - Parse request body: `{ briefData }`
   - Validáció: ha nincs briefData, return 400 { error: "Hiányzó brief adatok" }
   - JSX elem létrehozása: `const pdfElement = <BriefPDF data={briefData} />`
   - `const pdfBuffer = await renderToBuffer(pdfElement)`
   - Return: new Response(pdfBuffer, { headers: { "Content-Type": "application/pdf", "Content-Disposition": "attachment; filename=\"roi-works-brief.pdf\"" } })
   - try/catch: hiba esetén return 500 { error: "Hiba a PDF generálás során" }

A pattern pontosan követi a meglévő send-brief route JSX-outside-try-catch mintáját.
  </action>
  <verify>npx tsc --noEmit app/api/download-pdf/route.tsx — nincs TS hiba.</verify>
  <done>A /api/download-pdf endpoint POST kérésre PDF buffer-t ad vissza Content-Type: application/pdf fejléccel.</done>
</task>

<task type="auto">
  <name>Task 2: Email template + send-brief route átírás flat sémára</name>
  <files>lib/email-template.ts, app/api/send-brief/route.tsx</files>
  <action>
**lib/email-template.ts TELJES ÁTÍRÁS:**

A jelenlegi email template a régi nested sémát használja (data.company.name, data.campaign.goal). Írd át a flat BriefData sémára dinamikus szekcióval.

1. Import: BriefData, CampaignType, CAMPAIGN_TYPE_LABELS from @/types/brief.

2. Implementálj inline hasValue/getNestedValue/formatValue helper-eket (hasonlóan mint a pdf-template-ben). Ez szükséges mert a template inline HTML-t generál.

3. Szekció definíciók: ugyanaz a struktúra mint a brief-sections.ts-ben (BASE + type-specific). Duplikálás szükséges mert HTML string-eket generálunk.

4. `generateEmailHtml(data: BriefData): string`:
   - HTML email table layout (megtartva a jelenlegi inline CSS, table role="presentation" pattern-t)
   - Fejléc: ROI WORKS (narancs accent) + dátum — sötét háttér (#2A2B2E)
   - Kampánytípus badge-ek a fejléc alatt (narancs háttér, fehér szöveg)
   - Szekciók: iteráld a releváns szekciókat, szűrd ki az üres mezőket
     - Szekció cím: narancs (#FF6400), border-bottom #E3E3E3
     - Mezők: label (#3C3E43) + value (#2A2B2E) table sorok
     - Tömb értékek: vesszővel elválasztva
   - Üres szekciók NE jelenjenek meg
   - Lábléc: "Ez a brief a ROI Works AI asszisztensével készült." + copyright

5. Az email formátuma és stílusa a jelenlegi pattern-t követi (inline CSS, table layout), de a szekciók dinamikusak.

**app/api/send-brief/route.tsx MÓDOSÍTÁS:**

1. A jelenlegi recipient lista tartalmazza a clientEmail-t (az érdeklődőt is megcímzi). Módosítsd:
   - Email CSAK a ROI Works csapatnak megy: `BRIEF_RECIPIENT_1`, `BRIEF_RECIPIENT_2` (env vars)
   - A clientEmail NE legyen a recipient listában
   - A clientEmail legyen benne a brief adatokban (a ROI Works csapat innen éri el)
   - Ha nincs BRIEF_RECIPIENT konfigurálva, return 500 { error: "Nincs konfigurált címzett" }

2. A subject: `Kampány Brief: ${data.company_name || "Új brief"}` — flat séma mező (nem data.campaign.name)

3. Az email attachment fájlneve: `brief-${(data.company_name || "brief").toLowerCase().replace(/\s+/g, "-")}.pdf`

4. A clientEmail-t add hozzá az email body-hoz: "Érdeklődő email: {clientEmail}" sor a fejlécben vagy a szekciók előtt, hogy a ROI Works csapat lássa.

5. Tartsd meg a jelenlegi SendGrid error handling pattern-t (401, 403 specifikus üzenetek).
  </action>
  <verify>npx tsc --noEmit lib/email-template.ts app/api/send-brief/route.tsx — nincs TS hiba. A send-brief route NEM tartalmaz clientEmail-t a recipients listában.</verify>
  <done>Az email template dinamikus szekciókat használ flat sémával. A send-brief route csak a ROI Works-nek küld emailt. A PDF letöltés endpoint kész.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — nincs TS hiba a 3 fájlban
2. A email-template.ts NEM tartalmaz régi nested eléréseket (data.company.name, data.campaign.goal)
3. A send-brief route recipients listája NEM tartalmaz clientEmail-t
4. Az /api/download-pdf route létezik és POST-ot exportál
5. `npm run build` sikeresen lefut (vagy legalább nincs TS hiba)
</verification>

<success_criteria>
- PDF letöltés endpoint: POST /api/download-pdf → PDF buffer válasz
- Email csak ROI Works-nek megy (BRIEF_RECIPIENT_1, BRIEF_RECIPIENT_2)
- Email template dinamikus szekciókkal, flat sémával, ROI Works arculat
- Send-brief route flat séma mezőket használ (company_name, nem data.company.name)
- Nincs TS hiba az érintett fájlokban
</success_criteria>

<output>
After completion, create `.planning/phases/03-dynamic-report-branding/03-03-SUMMARY.md`
</output>
